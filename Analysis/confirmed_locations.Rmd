---
title: "Mapping and Analysis of Manually Cleaned Data"
author: "Nikhil Kalathil"
date: "08/01/2020"
output:
  html_document:
    df_print: paged
    toc: true
    toc_float: true
    theme: flatly
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

This document takes manually checked data on domestic manufacturing locations, builds a geocoded company-location-address base sheet to reference all files against, creates a few summary graphs, and formats the data to be used in leaflet mapping. 

```{r, include == FALSE }
library(tidyverse)
library(tidytext)
library(RColorBrewer)
library(ggthemes)
library(tm)
library(here)
library(ggrepel)
library(lubridate)
library(ggnewscale)
library(readxl)
library(htmltools)
library(htmlwidgets)
library(RJSONIO)
```
```{r}

box_dir <- "C:/Users/Nikhil Kalathil/Box/COVID 19 Master Folder/Data/Masks/"

```

```{r}
box_here <- function(file) {
  paste(box_dir, file, sep = "")
}
```



```{r}
thomas_an <- readRDS(here("Data/Cleaned/fm_resp.RDS"))
int_prod <- readRDS(here("Data/Cleaned/int_prod.RDS"))
```

```{r}
int_prod <- int_prod %>% 
  mutate(company = if_else(company == "Precision Custom Coatings LLC", "Precision Textiles", company),
         company = if_else(str_detect(company, "Alliance Rubber"), "Alliance Rubber Company", company)
         )
```


```{r}
thomas_struc <- bind_rows(int_prod, thomas_an) %>% 
  mutate(company = case_when(
    str_detect(company, "United Sewing Automation") ~ "United Sewing Automation, Inc.", 
    TRUE ~ company
  ), 
  company = case_when(
    str_detect(company, "Shawmut") ~ "Shawmut Corporation",
    TRUE ~ company
  ),
  company = case_when(
    str_detect(company, "Honeywell") ~ "Honeywell Safety Products", 
    TRUE ~ company
  ), 
  company = case_when(
    str_detect(company, fixed("pzero", ignore_case = TRUE)) ~ "PZero Innovations Inc.", 
    TRUE ~ company
  )) %>% 
  mutate(broad_loc = case_when(
    str_detect(broad_loc, "Manuf") ~ "Manufacturer", 
    str_detect(broad_loc, "Dist") ~ "Distributor",
    TRUE ~ "Other/Unknown"
  ), 
  broad_loc = case_when(
    str_detect(desc, fixed("distributor", ignore_case = TRUE)) & str_detect(desc, fixed("manufacturer", ignore_case = TRUE), negate = TRUE) ~ "Distributor", 
    TRUE ~ broad_loc
  )) %>%  
  mutate(useful == if_else(company %in% c("Prestige Ameritech", "Huajian US Services, Corp", "Bossong Hosiery Mills, Inc."), "Affirmatively", useful)) %>% 
  group_by(specific_product, company, date) %>% 
  mutate(tal = seq(n())) %>% 
  filter(tal == 1)
```

# Importing Manually Checked Data

We begin with importing manually checked data for each product category. 

```{r}
aff_comps <- thomas_struc %>% 
  filter(specific_product != "NA", broad_loc == "Manufacturer" ) %>% 
  mutate(useful = case_when(
    is.na(useful) ~ "Unknown", 
    TRUE ~ useful
  )) %>%
  filter(useful == "Affirmatively") %>% 
  mutate(company = if_else(company == "Monadnock Paper Mills, Inc.", "Monadnock Non-Wovens LLC", company),
         company = if_else(company == "Consolidated Cordage Corporation", "Consolidated Cordage Corp.", company) ,
         company = if_else(str_detect(company, "Guardsman Gl"), "Guardsman Global", company), 
         company = if_else(str_detect(company, "USAmedical"), "USA Medical Supply", company)) 
```

## Importing Data 

```{r}
conf_nl <- read_xlsx(box_here("manf_comps.xlsx"), sheet = "No Latex") %>% 
    filter(useful == "Affirmatively" | is.na(useful)) %>% 
  select(-(5:17)) %>% 
  mutate(from = 1, 
         specific_product = "No Latex Elastic",
         dom_useful = as.character(dom_useful))
```


```{r}
conf_nw <- read_xlsx(box_here("manf_comps.xlsx"), sheet = "Non Woven") %>% 
  filter(useful == "Affirmatively" | is.na(useful)) %>% 
  select(-(5:17)) %>% 
  mutate(from = 1, 
         specific_product = "Non-Woven Fabric")
```

```{r}
conf_resp <- read_xlsx(box_here("manf_comps.xlsx"), sheet = "Respirator Only") %>% 
  filter(useful == "Affirmatively" | is.na(useful)) %>% 
  select(-(6:18)) %>% 
  mutate(from = 1, 
         specific_product = "Respirators Only") 
```

```{r}
conf_fm <- read_xlsx(box_here("manf_comps.xlsx"), sheet = "FM Only") %>% 
  filter(useful == "Affirmatively" | is.na(useful)) %>% 
  select(-(6:18)) %>% 
  mutate(from = 1, 
         specific_product = "Face Masks Only") 
```

```{r}
conf_fmresp <- read_xlsx(box_here("manf_comps.xlsx"), sheet = "Resp & FM") %>% 
  filter(useful == "Affirmatively" | is.na(useful)) %>% 
  select(-(6:18)) %>% 
  mutate(from = 1, 
         specific_product = "Respirators and Face Masks") 
```

### Check for Each Product and Write New Entries to a CSV

#### NL Tests
```{r}
aff_nl <- aff_comps %>% 
  filter(specific_product == "No Latex Elastic") %>% 
  left_join(conf_nl)
```
```{r}
aff_nl %>% 
  filter(is.na(from)) %>% 
  view()
```

```{r}
aff_nl %>% 
  group_by(specific_product, date) %>% 
  count()
```

#### NW Tests
```{r}
aff_nw <- aff_comps %>% 
  filter(specific_product == "Non-Woven Fabric") %>% 
  left_join(conf_nw)
```

```{r}
aff_nw %>% 
  filter(is.na(from)) %>% 
  view()
```

```{r, eval = FALSE}
aff_nw %>% 
  filter(is.na(from)) %>% 
  write_csv(box_here("new_comps.csv"))
```

```{r}
aff_nw %>% 
  group_by(specific_product, date) %>% 
  count()
```

```{r}
aff_nw <- aff_nw %>% 
  group_by(company, date) %>% 
  mutate(tal = seq(n())) %>% 
  filter(tal == 1)
```


#### Resp only tests
```{r}
aff_resp <- aff_comps %>% 
  filter(specific_product == "Respirators Only") %>% 
  left_join(conf_resp)
```
```{r}
aff_resp %>% 
  filter(is.na(from)) %>% 
  view()
```

```{r, eval = FALSE}
aff_resp %>% 
  filter(is.na(from)) %>% 
  write_csv(box_here("new_comps.csv"))
```


```{r}
aff_resp %>% 
  group_by(specific_product, date) %>% 
  count()
```



```{r}
aff_resp <- aff_resp %>% 
  group_by(company, date) %>% 
  mutate(tal = seq(n())) %>% 
  filter(tal == 1)
```

#### FM Only Tests
```{r}
aff_fm <- aff_comps %>% 
  filter(specific_product == "Face Masks Only") %>% 
  left_join(conf_fm)
```
```{r}
aff_fm %>% 
  filter(is.na(from)) %>% 
  view()
```

```{r}
aff_fm %>% 
  group_by(specific_product, date) %>% 
  count()
```

```{r, eval = FALSE}
aff_fm %>% 
  filter(is.na(from)) %>% 
  write_csv(box_here("new_comps.csv"))
```
```{r}
aff_fm <- aff_fm %>% 
  group_by(company, date) %>% 
  mutate(tal = seq(n())) %>% 
  filter(tal == 1)
```

#### FM+RESP Tests
```{r}
aff_fmresp <- aff_comps %>% 
  filter(specific_product == "Respirators and Face Masks") %>% 
  left_join(conf_fmresp) %>% 
    mutate(company = if_else(company == "RPB Safety", "RPB Safety, LLC.", company),
           company = if_else(company == "PZero Inc.", "PZero Innovations Inc.", company),
           company = if_else(company == "Pzero Innovations Inc.", "PZero Innovations Inc.", company),
           company = if_else(company == "Rhysley Ltd.", "Rhysley, Ltd.", company),
           company = if_else(company == "Y-Not Design & Mfg. Inc", "Y-Not Design & Mfg. Inc.", company), 
           company = if_else(company == "Lynktrac Technologies, LLC", "LynkTrac Technologies, LLC", company),
           company = if_else(company == "Cura, a Division of CustomFab USA", "Ceemly, a Division of CustomFab USA", company)) 
```

```{r}
aff_fmresp %>% 
  filter(is.na(from)) %>% 
  view()
```

```{r, eval = FALSE}
aff_fmresp %>% 
  filter(is.na(from)) %>%
  select(-c("cat_1", "cat_2", "cat_3")) %>% 
  write_csv(box_here("new_comps.csv"))
```


```{r}
aff_fmresp %>% 
  group_by(specific_product, date) %>% 
  count()
```

```{r}
aff_fmresp <- aff_fmresp %>% 
  group_by(company, date) %>% 
  mutate(tal = seq(n())) %>% 
  filter(tal == 1)
```



### Combine and Graph 

```{r}
all_dom <- bind_rows(aff_fm, aff_resp) %>% 
  bind_rows(aff_fmresp) %>% 
  mutate(company = if_else(company == "Grayko", "GrayKo", company)) %>% 
  mutate(specific_product = if_else(company %in% c("Safe Health", "Luosh USA, LLC", "PandMedic Solutions", "Alpha Pro Tech, Ltd.", "Guardis Medical
", "Phenotype Pharmaceuticals", "Sanitizing Solutions", "Maine-Lee Technology Group, LLC / EZ-Glider", "Pureco USA, LLC"), "Respirators and Face Masks", specific_product),
specific_product = if_else(company %in% c("United States Mask", "United Safety Technology Inc.", "Oxystrap International", "Shawmut Corporation", "Protective Health Gear"), "Respirators Only", specific_product),
specific_product = if_else(company %in% c("Guardis Medical", "Hero Life Sciences, Inc.", "PZero Innovations Inc.", "Sanctuary Systems, LLC", "SpinTech, LLC", "Acropure"), "Face Masks Only", specific_product)) %>% 
  bind_rows(aff_nl) %>% 
  bind_rows(aff_nw) %>% 
  group_by(company, specific_product, date) %>% 
  mutate(tal = seq(n())) %>% 
  filter(tal == 1)
```

For each product, for companies that list themselves as affirmatively producing a standard FDA product for surgical grade masks/respirators, we have manually checked every entry. We export these data and manually impute firmographic information from D&B Hoovers. 

```{r}
all_dom %>% 
  ungroup() %>% 
  select(company, dom_useful, FLAG, manf_loc, address, parent_ownership, specific_product, date, useful, corporate_family_dbh, atsite_emp_dbh, all_site_emp_dbh, sales_dbh, DUNS, employees, date_founded, sales) %>% 
  group_by(company, specific_product) %>% 
  mutate(min_date = min(ymd(date)),
         max_date = max(ymd(date))) %>% 
  mutate(tal = seq(n())) %>% 
  filter(tal == 1) %>% 
  saveRDS(box_here("validated.RDS"))
```

```{r}
all_dom %>% 
  ungroup() %>% 
  select(company, dom_useful, FLAG, manf_loc, address, parent_ownership, specific_product, date, useful, corporate_family_dbh, atsite_emp_dbh, all_site_emp_dbh, sales_dbh, DUNS, employees, date_founded, sales) %>%
  group_by(company, specific_product) %>% 
  mutate(min_date = min(ymd(date)),
         max_date = max(ymd(date))) %>% 
  mutate(tal = seq(n())) %>% 
  filter(tal == 1) %>%
  write_csv(box_here("confirmed_domestic.csv"))
```


```{r}
confirmed_dbh <- read_csv(box_here("confirmed_domestic_dbh.csv")) %>% mutate(checked = 1) %>% mutate(
  across(where(is.numeric), ~ case_when(. == "NA" ~ NA_real_,
                                        TRUE ~as.numeric(.))), 
  across(where(is.character), ~ case_when(. == "NA" ~ NA_character_,
                                        TRUE ~as.character(.)))) %>% 
  filter(dom_useful == 1)

```

We save our imputed data to merge later. 

## Combining With All Thomasnet

```{r}
dom_to_thomas <- all_dom %>% 
  ungroup() %>% 
  select(-c(corporate_family_dbh, atsite_emp_dbh, all_site_emp_dbh, sales_dbh, DUNS, employees, date_founded, sales))
```

```{r}
thomas_clean <- thomas_struc %>% 
  filter(specific_product != "NA", broad_loc == "Manufacturer" ) %>% 
  mutate(useful = case_when(
    is.na(useful) ~ "Unknown", 
    TRUE ~ useful
  )) %>%
  filter(useful != "Affirmatively") %>% 
  mutate(company = if_else(company == "Monadnock Paper Mills, Inc.", "Monadnock Non-Wovens LLC", company),
         company = if_else(company == "Consolidated Cordage Corporation", "Consolidated Cordage Corp.", company) ,
         company = if_else(str_detect(company, "Guardsman Gl"), "Guardsman Global", company), 
         company = if_else(str_detect(company, "USAmedical"), "USA Medical Supply", company)) %>%
  bind_rows(dom_to_thomas) %>% 
  mutate(company = if_else(company == "Moss", "Moss Inc.", company), 
         company = if_else(str_detect(company, "AmeriShield"), "Premium PPE - Amerishield", company)) 
```

We convert our manually entered validated domestic columns into numeric variables. We then define a unique company entry as a company supplier listing for a specific product at a specific level of usefuleness. This will allow us to understand how companies changed their descriptions of themselves over time. 

```{r}
thomas_clean_simple <- thomas_clean %>% 
  group_by(company) %>% 
  mutate(dom_useful_num = case_when(
    dom_useful == "1" ~ 1, 
    is.na(dom_useful) ~ -2, 
    dom_useful %in% c("Possibly") ~ -1, 
    dom_useful %in% c("0") ~ 0,
  ) ,
  manf_loc_num = case_when(
    manf_loc == 1 ~ 1, 
    is.na(manf_loc) ~ -1,
    manf_loc == 0 ~ 0 
  )) %>% 
  mutate(dom_useful_num = max(dom_useful_num, na.rm = TRUE), 
         manf_loc = max(manf_loc_num, na.rm = TRUE)) %>% 
  select(company, location, useful, date, specific_product, dom_useful_num, manf_loc, desc, address, date_founded, sales, employees, FLAG) %>% 
  group_by(company, specific_product, useful) %>% 
  mutate(min_date = min(ymd(date)),
         max_date = max(ymd(date))) %>% 
  mutate(tal = seq(n())) %>% 
  filter(tal == 1) %>% 
  select(-c(tal)) %>% 
  mutate(thomasnet = 1)
```

```{r}
saveRDS(thomas_clean_simple, box_here("thomas_clean.RDS"))
```

We now impute our data from DB Hoovers. 

## Combining DB Hoovers and Thomasnet 

```{r}
dbh_merge <- confirmed_dbh %>% 
  mutate(company = if_else(company == "Moss", "Moss Inc.", company), 
         company = if_else(str_detect(company, "AmeriShield"), "Premium PPE - Amerishield", company)) %>% 
  select(company, DUNS, atsite_emp_dbh, all_site_emp_dbh, sales_dbh, corporate_family_dbh)
```

```{r}
thomas_dbh <- thomas_clean_simple %>% 
  left_join(dbh_merge)
```

```{r}
thom_dbh <- thomas_dbh %>% 
  select(-c(address))

thomas_dbh <- thomas_dbh %>% 
  ungroup() %>% 
  select(company, address) %>% 
  filter(!is.na(address)) %>% 
  left_join(thom_dbh, .)
```

We now simplify our list of companies 

```{r}
thomas_dbh_clean <- thomas_dbh %>% 
  mutate(company = case_when(
    str_detect(company, "MSA") ~ "MSA Safety, Inc.", 
    str_detect(company, "Drager") ~ "Draeger Inc.",
    str_detect(company, "CustomFab") ~ "CustomFab USA, Inc.",
    str_detect(DUNS, "14-424-0728") ~ "NFI Masks LLC",
    str_detect(company, "Readi") | str_detect(company, "Global Safety First") ~ "Global Safety First",
    TRUE ~ company
  )) %>% 
  mutate(num_useful = case_when(
      useful == "Affirmatively" ~ 3,
      useful == "Possibly" ~ 2,
      useful == "Unknown" ~ 1,
      is.na(useful) ~ 0
    )) %>% 
  group_by(company) %>% 
  mutate(min_date = min(min_date),
         max_date = max(max_date), 
         min_aff = case_when(
           useful == "Affirmatively" ~ min(min_date))) %>%  
  mutate(min_aff = max(min_aff, na.rm = TRUE), 
    max_useful = max(num_useful, na.rm = TRUE)) %>% 
  mutate(useful = case_when(
    max_useful == 3 ~ "Affirmatively", 
    max_useful == 2 ~ "Possibly", 
    max_useful == 1 ~ "Unknown", 
    max_useful == 0 ~ "Missing"
  )) %>% 
  mutate(tot_entries = n()) %>% 
  filter(specific_product != "Cloth Masks") %>% 
  mutate(tal = seq(n())) %>% 
  filter(tal == 1) %>% 
  select(-c(tal)) 
```

```{r}
aime <- thomas_dbh_clean %>% 
  filter(str_detect(company, fixed("aime", ignore_case = TRUE))) %>% 
  mutate(company = "Aime, LLC") %>% 
  group_by(company) %>% 
  mutate(min_date = min(min_date),
         max_date = max(max_date), 
         min_aff = case_when(
           useful == "Affirmatively" ~ min(min_date)), 
         tal = seq(n())) %>% 
  filter(tal == 2)

thomas_dbh_clean <- thomas_dbh_clean %>% 
  filter(!str_detect(company, fixed("aime", ignore_case = TRUE))) %>%
  bind_rows(aime) 
```

```{r}
conf_dom <- thomas_dbh %>% 
  ungroup() %>% 
  filter(dom_useful_num == 1) %>% 
  select(company, address, desc, specific_product, date, specific_product, date_founded, sales, employees, manf_loc, corporate_family_dbh, all_site_emp_dbh, sales_dbh, DUNS)
```

## Import USBDM Data

```{r}
amma <- read_xlsx(box_here("usabdm_list.xlsx")) %>% 
  mutate(amma = 1) %>% 
  select(-c(interview, vertical, '...5'))
```

## Merge with Thomasnet Data

```{r}
anti_thomas_amma <- anti_join(amma, thomas_dbh_clean, by = c("company")) %>% 
  select(company, specific_product = specific_product_bdm, 
         address = address_man,
         corporate_family_dbh, atsite_emp_dbh, all_site_emp_dbh, sales_dbh, DUNS, 
         manf_loc_amma, 
         amma, bdm_country) %>% 
  filter(company != "Other", bdm_country == "USA") %>% 
  mutate(bdm_country = "US")
```

```{r}
thomas_amm1 <- thomas_dbh_clean %>% 
  filter(useful == "Affirmatively") %>% 
  left_join(amma)

thomas_amm2 <- thomas_dbh_clean %>% 
  filter(useful != "Affirmatively") %>% 
  select(-c(corporate_family_dbh, atsite_emp_dbh, all_site_emp_dbh, sales_dbh, DUNS)) %>% 
  left_join(amma)

thomas_amma <- bind_rows(thomas_amm1, thomas_amm2) %>% 
  bind_rows(anti_thomas_amma)
```

```{r}
thomas_amma %>% 
  select(company, specific_product, useful, amma, dom_useful_num, manf_loc, min_date, max_date, date, thomasnet, DUNS, amma) %>% 
  view()
```

```{r}
match1_clean <- thomas_amma %>% 
  ungroup() %>% 
  select(company, location, specific_product, useful, amma, dom_useful_num, manf_loc, min_date, max_date, min_aff, date, desc, bdm_country, address, address_man, manf_loc_amma, thomasnet, corporate_family_dbh, atsite_emp_dbh, all_site_emp_dbh, sales_dbh, DUNS, tot_entries) %>% 
  mutate(dom_useful_mark = dom_useful_num, 
         dom_useful_num = case_when(
    amma == 1 | dom_useful_num == 1 ~ 1, 
    TRUE ~ dom_useful_num), 
         manf_loc = case_when(
           manf_loc_amma == 1 ~ manf_loc_amma, 
           TRUE ~ manf_loc))  %>% 
  mutate(DUNS = str_trim(gsub("-", "", DUNS)),
        DUNS = case_when(
    str_detect(company, "Premium PPE - Amerishield") ~ "XX-01", 
    TRUE ~ DUNS
  ))
```

## Bring in Interviews

```{r}
remove <- c("Limited" ,"Ltd", "LTD", "Incorporated", "Company",  "Corporation", "Co", "Inc",  "[[:punct:]]", "LLC")
```
```{r}
interviews <- readRDS(box_here("interviews.RDS")) %>% 
  filter(!str_detect(company, "Honeywell")) %>% 
  select(DUNS, company) %>% 
  mutate(interview = 1) %>% 
  mutate(comp_match = tolower(str_trim(str_remove_all(company, paste(remove, collapse = "|")))), 
         DUNS = case_when(
    str_detect(company, "Premium-PPE Amerishield") ~ "XX-01", 
    TRUE ~ DUNS)) %>% 
  select(-c(company))
```

```{r}
int_sample_holder <- match1_clean %>% 
  filter(!str_detect(company, "Honeywell")) %>% 
  left_join(interviews)
```
```{r}
int_anti <- readRDS(box_here("interviews.RDS")) %>% 
  select(company, corporate_family_dbh, atsite_emp_dbh, all_site_emp_dbh, sales_dbh, DUNS) %>%
  anti_join(int_sample_holder, by = "DUNS") %>% 
  filter(!str_detect(company, "Honeywell"))  %>% 
  mutate(interview = 1)
```

```{r}
int_honeywell <- readRDS(box_here("interviews.RDS")) %>% 
  select(company, corporate_family_dbh, atsite_emp_dbh, all_site_emp_dbh, sales_dbh, DUNS) %>% 
  mutate(interview = 1) %>% 
  mutate(company = case_when(
    str_detect(company, "Honeywell") ~ "Honeywell Safety Products",
    TRUE ~ company
  )) %>% 
  filter(str_detect(company, "Honeywell"))
```

```{r}
int_sample <- match1_clean %>% 
  filter(str_detect(company, "Honeywell")) %>% 
  select(-c(corporate_family_dbh, atsite_emp_dbh, all_site_emp_dbh, sales_dbh, DUNS)) %>% 
  left_join(int_honeywell) %>% 
  bind_rows(int_sample_holder) %>% 
  bind_rows(int_anti)
```

```{r}
int_sample_clean <- int_sample %>% 
  mutate(interview = case_when(
    str_detect(company, "Tex-Care") | str_detect(company, "Global Safety First") | str_detect(company, "MME group") ~ 1, 
    TRUE ~ interview), 
    company = case_when(
      DUNS == "117986953" ~ "US Meltblown", 
      DUNS == "832447812" ~ "General Motors", 
      DUNS == "061756185" ~ "Avery Dennison", 
      TRUE ~ company
    ),
    specific_product = case_when(
      str_detect(company, "NYPPE") | str_detect(company, "General Motors")  ~ "Respirators and Face Masks", 
      str_detect(company, "Fischer") ~ "Face Masks Only", 
      str_detect(company, "Avery") ~ "Respirators Only", 
      str_detect(company, "US Meltblown") ~ "Non-Woven Fabric", 
      TRUE ~ specific_product
    ), 
    broad_product = case_when(
      specific_product %in% c("Face Masks Only", "Respirators Only", "Respirators and Face Masks") ~ "Respirators and/or Face Masks", 
      specific_product %in% c("Non-Woven Fabric", "No Latex Elastic") ~ "Intermediary Product"
    ))
```

## Bring in Regulatory Approvals 

```{r}
all_reg <- readRDS(box_here("FDA/all_reg.RDS")) %>% 
  mutate(DUNS = str_trim(gsub("-", "", DUNS)),
        DUNS = case_when(
    str_detect(APPLICANT, "Premium-PPE ") ~ "XX-01", 
    str_detect(APPLICANT, "Secured Ortho") ~ "25",
    TRUE ~ DUNS
  ), 
  APPLICANT = case_when(
    str_detect(APPLICANT, "Thrace") ~ "Thrace-LINQ, Inc", 
    str_detect(APPLICANT, "Moldex") ~ "Moldex",
    TRUE ~ APPLICANT
  )) %>% 
  select(corporate_family_dbh, atsite_emp_dbh, all_site_emp_dbh, sales_dbh, DUNS, reg_type, ddate, APPLICANT, COUNTRY_CODE, private_us_subsidiary) %>% 
  filter(year(ddate)> 2019, COUNTRY_CODE == "US" | private_us_subsidiary == 1) %>% 
  mutate(comp_match = tolower(str_trim(str_remove_all(APPLICANT, paste(remove, collapse = "|"))))) %>% 
  group_by(comp_match, reg_type) %>% 
  mutate(min_appr = min(ddate), 
         tot_appr = n()) %>% 
  ungroup() %>% 
  select(corporate_family_dbh, atsite_emp_dbh, all_site_emp_dbh, sales_dbh, DUNS, comp_match, min_appr, COUNTRY_CODE, reg_type, tot_appr) %>% 
  distinct()
```

```{r}
reg_distinct <- all_reg %>% 
  select(-c(tot_appr)) %>% 
  mutate(reg_type = case_when(
    str_detect(reg_type, "NIOSH") ~ "niosh", 
    str_detect(reg_type, "510") ~ "fda_510", 
    str_detect(reg_type, "EUA") ~ "eua"
  )) %>% 
  pivot_wider(id_cols = -c("reg_type", "min_appr"), names_from = c("reg_type"), values_from = c("min_appr"))
```

```{r}
merge2_holder <- int_sample_clean %>% 
  select(-c(comp_match)) %>% 
  filter(!is.na(DUNS)) %>% 
  left_join(reg_distinct)
  
```

```{r}
merge2_anti <- anti_join(reg_distinct, merge2_holder)
```

```{r}
merge2 <- int_sample_clean %>% 
  filter(is.na(DUNS)) %>% 
  mutate(comp_match = tolower(str_trim(str_remove_all(company, paste(remove, collapse = "|"))))) %>% 
  select(-c(corporate_family_dbh, atsite_emp_dbh, all_site_emp_dbh, sales_dbh, DUNS)) %>% 
  full_join(merge2_anti) %>% 
  bind_rows(merge2_holder) %>% 
  mutate(niosh = case_when(
    str_detect(company, "Avery") ~ mdy("01/21/2021"), 
    TRUE ~ as.Date(niosh)
  ))
```
```{r}
merge2 %>% filter(!is.na(niosh) | !is.na(fda_510) | !is.na(eua), is.na(company)) %>% view()
```

### FUNCTION TEST

```{r}
dbinfo_merge <- function(data1, data2) { 
  
  merge_holder <- data1 %>% 
  select(-c(comp_match)) %>% 
  filter(!is.na(DUNS)) %>% 
  left_join(data2) 
  
  merge_anti <- anti_join(data2, merge_holder)
  
  merge <- data1 %>% 
  filter(is.na(DUNS)) %>% 
  mutate(comp_match = tolower(str_trim(str_remove_all(company, paste(remove, collapse = "|"))))) %>% 
  select(-c(corporate_family_dbh, atsite_emp_dbh, all_site_emp_dbh, sales_dbh, DUNS)) %>% 
  full_join(merge_anti) %>% 
  bind_rows(merge_holder)
  
  return(merge)
  
  }
```

```{r}
merge3 <- dbinfo_merge(int_sample_clean, reg_distinct)
```

```{r}
anti_join(merge2, merge3)
```


## Bring in Contracts

```{r}
covid_contracts <- readRDS(box_here("/contracts/covid_contracts.RDS")) %>% 
  rename(numeric_duns = recipient_duns) %>% 
  mutate(numeric_duns = case_when(
    str_detect(company, "FEDERAL PRISON") ~ 626627459,
    str_detect(company, "AURORA") ~ 079538271, 
    str_detect(company, "FEDERAL RESOURCES") ~ 091235377, 
    str_detect(company, "FISHER SCIENTIFIC") ~ 004321519, 
    str_detect(company, "RELIANCE WHOLESALE") ~ 613048789,
    str_detect(company, "HONEYWELL") ~ 139691877,
    str_detect(company, "LYDALL") ~ 001139963,
    str_detect(company, "CROSSTEX") ~ 057728685,
    TRUE ~ numeric_duns
  ), 
  company = case_when(
    numeric_duns == 44549434 ~ "Draeger Inc.", 
    numeric_duns == 66237736 ~ "Moldex", 
    numeric_duns == 116926824 ~ "MSA Saftey, Inc.",
    TRUE ~ company
  )) %>% 
  group_by(numeric_duns) %>% 
  mutate(first_contract = min(solicitation_date), 
         total_contracts = n(), 
         total_dollars = sum(total_dollars_obligated), 
         tal = seq(n())) %>% 
  filter(tal == 1) %>% 
  select(contract_comp = company, numeric_duns, first_contract, total_contracts, total_dollars, company_category)
```

```{r}
length(unique(covid_contracts$numeric_duns))
```
SAME SHIT AS ABOVE -- DO IT RIGHT

```{r}
merge3_holder <- merge2 %>% 
  filter(!is.na(DUNS)) %>% 
  mutate(numeric_duns = as.numeric(DUNS)) %>% 
  left_join(covid_contracts)
```
```{r}
merge3_anti <- anti_join(covid_contracts, merge3_holder) %>% 
  mutate(comp_match = tolower(str_trim(str_remove_all(tolower(contract_comp), paste(tolower(remove), collapse = "|")))))
```

```{r}
merge3 <- merge2 %>% 
  filter(is.na(DUNS)) %>% 
  left_join(merge3_anti) %>% 
  bind_rows(merge3_holder)
```

## Finalizing the Sample

```{r}
reg_names <- readRDS(box_here("FDA/all_reg.RDS")) %>% 
  filter(COUNTRY_CODE == "US") %>% 
  mutate(DUNS = str_trim(gsub("-", "", DUNS)),
        DUNS = case_when(
    str_detect(APPLICANT, "Premium-PPE ") ~ "XX-01", 
    str_detect(APPLICANT, "Secured Ortho") ~ "25",
    TRUE ~ DUNS
  ), 
  APPLICANT = case_when(
    str_detect(APPLICANT, "Thrace") ~ "Thrace-LINQ, Inc", 
    str_detect(APPLICANT, "Moldex") ~ "Moldex",
    TRUE ~ APPLICANT
  )) %>% 
  select(APPLICANT, DUNS) %>% 
  mutate(comp_match = tolower(str_trim(str_remove_all(APPLICANT, paste(remove, collapse = "|"))))) %>% 
  distinct() %>% 
  group_by(DUNS) %>% 
  mutate(tal = seq(n())) %>% 
  filter(tal == 1) %>% 
  select(-c(tal)) %>% 
  ungroup()
```

```{r}
matched_sample <- merge3 %>% 
  left_join(reg_names) %>% 
  mutate(company = case_when(
    is.na(company) & !is.na(APPLICANT) ~ APPLICANT, 
    TRUE ~ company
  ), 
  niosh_counter = !is.na(niosh),
  fda_counter = !is.na(fda_510) | !is.na(eua),
  contract_counter = !is.na(first_contract), 
  specific_product = case_when(
    is.na(specific_product) & niosh_counter == 1 & fda_counter == 1 ~ "Respirators and Face Masks", 
    is.na(specific_product) & niosh_counter == 1 & fda_counter != 1 ~ "Respirators Only", 
    is.na(specific_product)  & niosh_counter == 0 & fda_counter == 1 ~ "Face Masks Only", 
    TRUE ~ specific_product
  )) %>% 
  mutate(broad_product = case_when(
    specific_product %in% c("Respirators Only", "Respirators and Face Masks", "Face Masks Only") ~ "End Product", 
    specific_product %in% c("Non-Woven Fabric", "No Latex Elastic") ~ "Intermediary Product")) %>% 
  mutate(broad_product = case_when(
    broad_product == "Intermediary Product" & niosh_counter == 1 ~ "End Product", 
    broad_product == "Intermediary Product" & fda_counter == 1 ~ "End Product", 
    TRUE ~ broad_product
  ))
```
```{r}
matched_sample %>% filter(!is.na(DUNS) | !is.na(numeric_duns) | str_detect(company, "MME group"), is.na(atsite_emp_dbh)) %>%  select(company, DUNS, numeric_duns, comp_match) %>% write_csv(box_here("matched_sample_supp.csv"))
```

```{r}
sample_extra <- read_csv(box_here("matched_sample_dbh.csv")) %>% 
  mutate(DUNS = str_trim(gsub("-", "", DUNS)))
```

```{r}
matched_holder <- anti_join(matched_sample, sample_extra, by = c("company", "comp_match", "numeric_duns")) %>% 
  filter(!str_detect(company, "MME group"))
```


```{r}
final_sample <- matched_sample %>% 
  filter(!is.na(DUNS) | !is.na(numeric_duns) | str_detect(company, "MME group"), is.na(atsite_emp_dbh)) %>% 
  select(-c(corporate_family_dbh, atsite_emp_dbh, all_site_emp_dbh, sales_dbh, DUNS, numeric_duns)) %>% 
  left_join(sample_extra) %>% 
  bind_rows(matched_holder) 
```
```{r}
reg_address <- readRDS(box_here("FDA/all_reg.RDS")) %>% 
  filter(COUNTRY_CODE == "US") %>% 
  mutate(DUNS = str_trim(gsub("-", "", DUNS)),
        DUNS = case_when(
    str_detect(APPLICANT, "Premium-PPE ") ~ "XX-01", 
    str_detect(APPLICANT, "Secured Ortho") ~ "25",
    TRUE ~ DUNS
  ), 
  APPLICANT = case_when(
    str_detect(APPLICANT, "Thrace") ~ "Thrace-LINQ, Inc", 
    str_detect(APPLICANT, "Moldex") ~ "Moldex",
    TRUE ~ APPLICANT
  )) %>% 
  select(DUNS, fda_address = address, STATE) %>% 
  filter(!is.na(fda_address) | !is.na(STATE))
```

```{r}
final_sample <- final_sample %>% 
  left_join(reg_address) %>% 
  mutate(address = case_when(
    is.na(address) & !is.na(fda_address) ~ fda_address, 
    TRUE ~ address
  ))
```
```{r}
final_sample  %>% saveRDS(box_here("matched_sample.RDS"))
```


## Geocoding

```{r}
matched_sample <- readRDS(box_here("matched_sample.RDS"))
```


```{r}
sample_address <- matched_sample %>% 
  select(company, DUNS, numeric_duns, address, location, address_man) %>%
  mutate(location = case_when(
    str_detect(location, "Multiple Locs") ~ " ", 
    TRUE ~ location
  ), 
    address = case_when(
    is.na(address) & !is.na(address_man) ~ address_man, 
    is.na(address) & !is.na(location) ~ location, 
    TRUE ~ address
  ), 
  address = paste(company, address, "USA", sep = ", "))
```


```{r, echo = FALSE, Include = FALSE}
api_key <- c("AIzaSyA1pwzK3BaX7_um-_TUrS7aGfCHQvp68b8")
```

We define our function, which will take an address as an input and output a latitude and longitude result. 

```{r}
geocodeAddress <- function(address) {
  require(RJSONIO)
  url <- "https://maps.googleapis.com/maps/api/geocode/json?address="
  url <- URLencode(paste(url, address, sep = ""))
  url <- URLencode(paste(url, "&key=", api_key, sep = ""))
  x <- fromJSON(url, simplify = FALSE)
  print(x$status)
  if (x$status == "OK") {
    out <- c(x$results[[1]]$geometry$location$lng,
             x$results[[1]]$geometry$location$lat,
             x$results[[1]]$formatted_address)
  } else {
    out <- NA
  }
  Sys.sleep(0.2)  # API only allows 5 requests per second
  out
}
```


```{r, include = FALSE}
for(i in 1:nrow(sample_address))
{
  result <- geocodeAddress(sample_address$address[i])
  sample_address$long[i] <- as.numeric(result[1])
  sample_address$lat[i] <- as.numeric(result[2])
  sample_address$form_address[i] <- as.character(result[3])

}
```

```{r}
sample_unmatched <- sample_address %>% 
  filter(is.na(form_address))  %>% 
  select(company, DUNS, numeric_duns, location)
```

```{r}
unmatched_addresses <- c("90 State Street, Albany, New York, United States", 
  "3116 Coleshire Dr, Richardson, Texas, United States", 
  "11412 Se 31st Ave, Milwaukie, Oregon, United States", 
  "901 N Pollard St, Arlington VA 22203", 
  "",
  "4500 140TH AVE. NORTH, CLEARWATER, FL, 33762", 
  "275 Centre St, Holbrook, MA, United States", 
  "975 Industrial Dr., Madison, Indiana 47250", 
  "2823 Fuchsia Pl, Riverside, CA,  92503", 
  "20784 Eskridge Ct, Sterling, VA, United States", 
  "7814 Austin St Forest Hills, NY 11375", 
  "32582 South Round Head Dr, Solon, Ohio, 44139, USA", 
  "290 Industrial Drive, Hampshire, IL, United States", 
  "8 The Green, Dover, DE, 19901", 
  "865 NJ 33 Business, Freehold, NJ, 07728", 
  "", 
  "151 Calle de San Francisco Suite 201 SAN JUAN, Puerto Rico 00901", 
  "3016 Venergy Drive, Brookshire, TX, 77423", 
  "16727 Park Row, Houston, Texas, United States", 
  "3411 Hawthorne Rd Pocatello, ID, United States", 
  "1440 Koll Cir, San Jose, CA, United States",
  "800 E Colorado Blvd, Pasadena, CA", 
  "14271 Jeffrey Rd, Irvine, California",
  "63 Flushing Ave, New York, New York", 
  "161 Hill Ave Nw, Fort Walton Beach, FL")
```

```{r}
sample_unmatched$address <- unmatched_addresses
```

```{r}
sample_unmatched <- sample_unmatched %>% 
  filter(address != "") %>% 
  mutate(address = paste(company, address, "USA", sep = ", "))
```

```{r}
for(i in 1:nrow(sample_unmatched))
{
  result <- geocodeAddress(sample_unmatched$address[i])
  sample_unmatched$long[i] <- as.numeric(result[1])
  sample_unmatched$lat[i] <- as.numeric(result[2])
  sample_unmatched$form_address[i] <- as.character(result[3])

}
```
```{r}
sample_address_geocoded <- sample_address %>% 
  filter(!is.na(form_address)) %>% 
  bind_rows(sample_unmatched)
```

```{r}
sample_geocoded_draft <- matched_sample %>% 
  select(-c(address, location)) %>% 
  left_join(sample_address_geocoded)
```

```{r}
sample_geocoded_draft %>% 
  saveRDS(box_here("geocoded_11222021.RDS"))
```

```{r}
geocodeState <- function(long, lat) {
  require(RJSONIO)
  parameters <- str_c("&key=", api_key)
  apiRequests <- iconv(str_c("https://maps.googleapis.com/maps/api/geocode/json?latlng=", lat, ",", long, parameters), "", "UTF-8")
  x <- fromJSON(apiRequests, simplify = FALSE)
  print(x$status)
  if (x$status == "OK" & !is.null(x$results[[1]]$address_components)) {
    
    for(i in 1:length(x$results[[1]]$address_components)) {
      check <- x$results[[1]]$address_components[[i]]$type[[1]]
      
      if (check == "administrative_area_level_1") {
        print(check)
        
        out <- c(x$results[[1]]$address_components[[i]]$long_name,
             x$results[[1]]$address_components[[i]]$short_name)
      }
    }
  } else {
    out <- NA
  }
  Sys.sleep(0.2)  # API only allows 5 requests per second
  out
}
```

```{r}
x$results[[1]]$address_components[[3]]$type[[1]] == "administrative_area_level_1"
```
```{r}
length(x$results[[1]]$address_components)
```
```{r}
sample_geocoded_draft <- readRDS(box_here("geocoded_11222021.RDS"))
```


```{r}
sample_states <- sample_geocoded_draft %>% 
  filter(!is.na(lat))
```

```{r}
for(i in 1:nrow(sample_states))
{
  result <- geocodeState(sample_states$long[i], sample_states$lat[i])
  sample_states$state_name[i] <- as.character(result[1])
  sample_states$state_abbr[i] <- as.character(result[2])

}
```

```{r}
sample_states %>% 
  saveRDS(box_here("states_geocoded.RDS"))
```


```{r}
for (i in 1:nrow(sample_states)) {
  
sample_states$min_date_all[i] <-  min(sample_states$min_date[i], sample_states$fda_510[i], sample_states$eua[i], sample_states$niosh[i], sample_states$first_contract[i], na.rm = TRUE)
}
```


```{r}
sample_states %>% 
  filter(dom_useful_num == 1 | niosh_counter == TRUE | fda_counter == TRUE | contract_counter == TRUE | interview == 1) %>% 
  select(company, address, state_name, dom_useful_num, min_date_all, min_date, min_aff, fda_510, eua, niosh, first_contract, niosh_counter, fda_counter, contract_counter, thomasnet, amma, specific_product, interview, sales_dbh, corporate_family_dbh, DUNS, numeric_duns) %>% 
  view()
```
```{r}
sample_states_clean <- sample_states %>% 
  filter(dom_useful_num == 1 | niosh_counter == TRUE | fda_counter == TRUE | contract_counter == TRUE | interview == 1) %>% 
  select(company, address, form_address, state_name, state_abbr, specific_product, dom_useful_num, min_date_all, min_date, min_aff, fda_510, eua, niosh, first_contract, niosh_counter, fda_counter, contract_counter, thomasnet, amma, interview, sales_dbh, corporate_family_dbh, DUNS, numeric_duns, broad_product)  
```

```{r}
sample_states_clean %>% write_csv(box_here("state_sample.csv"))
```

```{r}
sample_states_clean %>% saveRDS(box_here("state_sample.RDS"))
```

```{r}
states_dbh <- read_csv(box_here("state_sample_update.csv")) %>% 
  select(company, dom_useful_num)
```

```{r}
sample_states_dbh <- sample_states_clean %>% 
  select(-c(dom_useful_num)) %>% 
  left_join(states_dbh)
```

```{r}
matched_sample_states <- sample_states %>% 
  mutate(indicator = dom_useful_num == 1 | niosh_counter == TRUE | fda_counter == TRUE | contract_counter == TRUE | interview == 1) %>% 
  filter(is.na(indicator)) %>% 
  bind_rows(sample_states_dbh)
```

```{r}
matched_sample_states %>% saveRDS(box_here("matched_states.RDS"))
```

## GRAPHS FOR Presentation! 

```{r}
matched_states <- readRDS(box_here("matched_states.RDS")) %>% 
  mutate(firm_size = case_when(
    sales_dbh < 1000000 ~ "Under $1 Mil", 
    sales_dbh >= 1000000 & sales_dbh < 10000000 ~ "$1M-$10M", 
    sales_dbh >= 10000000 & sales_dbh < 50000000 ~ "$10M-$50M", 
    sales_dbh >= 50000000 & sales_dbh < 1000000000 ~ "$50M-$1B", 
    sales_dbh >= 1000000000 ~ "$1B + "
  ), 
  size_pos = case_when(
    sales_dbh < 1000000 ~ 5, 
    sales_dbh >= 1000000 & sales_dbh < 10000000 ~ 4, 
    sales_dbh >= 10000000 & sales_dbh < 50000000 ~ 3, 
    sales_dbh >= 50000000 & sales_dbh < 1000000000 ~ 2, 
    sales_dbh >= 1000000000 ~ 1
  ))
```


### Sample Graphs

```{r}
matched_states %>% 
    filter(dom_useful_num == 1 | niosh_counter == TRUE | fda_counter == TRUE | contract_counter == TRUE | interview == 1, interview == 1) %>% 
  mutate(reg_counter = case_when(
        niosh_counter == TRUE | fda_counter == TRUE ~ "Regulatory Database", 
        TRUE ~ "No Regulatory Approval"
    )) %>% 
  select(company, reg_counter, dom_useful_num, thomasnet, amma, broad_product, firm_size, size_pos) %>%  view()
```


```{r}
sample_count <- matched_states %>% 
  filter(dom_useful_num == 1 | niosh_counter == TRUE | fda_counter == TRUE | contract_counter == TRUE | interview == 1) %>% 
  filter(dom_useful_num != 0) %>% 
  group_by(broad_product) %>% 
  count(interview, thomasnet, amma, niosh_counter, fda_counter, contract_counter, firm_size, size_pos)
```


```{r}
sample_cols <- c(brewer.pal(9, "BuGn")[2], brewer.pal(9, "Purples")[6])
```
```{r}
interview_count_end <- sample_count %>% 
  filter(broad_product == "End Product", interview == 1) %>% 
  mutate(tn = case_when(
    thomasnet == 1 ~ "Thomasnet", 
    is.na(thomasnet) ~ "Not on Thomasnet"
  ), 
  reg_counter = case_when(
    niosh_counter == TRUE | fda_counter == TRUE ~ "Regulatory Database", 
    TRUE ~ "No Regulatory Approval"
  )) %>% 
  group_by(tn, amma, reg_counter, interview) %>% 
  summarise(total = sum(n))
```

```{r}
interview_count_int <- sample_count %>% 
  filter(broad_product == "Intermediary Product") %>% 
  mutate(tn = case_when(
    thomasnet == 1 ~ "Thomasnet", 
    is.na(thomasnet) ~ "Not on Thomasnet"
  )) %>% 
  group_by(tn, amma, interview) %>% 
  summarise(total = sum(n))
```

```{r}
interview_count_contracts <- sample_count %>%  
  mutate(tn = case_when(
    thomasnet == 1 ~ "Thomasnet", 
    is.na(thomasnet) ~ "Not on Thomasnet"
  ),
  reg_counter = case_when(
    niosh_counter == TRUE | fda_counter == TRUE ~ "Regulatory Database", 
    TRUE ~ "No Regulatory Approval"
  )) %>% 
  group_by(tn, amma, reg_counter, contract_counter) %>% 
  summarise(total = sum(n))
```

```{r}
sample_base <- sample_count %>% 
  filter(broad_product == "End Product") %>% 
  mutate(tn = case_when(
    thomasnet == 1 ~ "Thomasnet", 
    is.na(thomasnet) ~ "Not on Thomasnet"
  ), 
  reg_counter = case_when(
    niosh_counter == TRUE | fda_counter == TRUE ~ "Regulatory Database", 
    TRUE ~ "No Regulatory Approval"
  )) %>% 
  group_by(tn, amma, reg_counter) %>% 
  summarise(total = sum(n)) %>% 
  ggplot() + 
  geom_col(aes(x = tn, y = total, group = amma, fill = as.factor(reg_counter)), position = "dodge", color = "black") +
  geom_label(aes(x = tn, y = total, group = amma, fill = as.factor(reg_counter), label = total), position = position_dodge(width = 0.9), color = "black", size = 5) + 
  scale_fill_manual(values = sample_cols) + 
  coord_flip() + 
  guides(fill = FALSE) +
  labs(x = "", y = "Number of Companies") + 
  theme_bw() + 
  theme(axis.text = element_text(size = 12), 
        axis.text.y = element_blank())
```


```{r}
size_col <- c(brewer.pal(9, "Blues")[9], brewer.pal(9, "Blues")[7], brewer.pal(9, "Blues")[6], brewer.pal(9, "Blues")[4], brewer.pal(9, "Blues")[3])
```

```{r}
sample_size_a <- sample_count %>% 
  mutate(tn = case_when(
    thomasnet == 1 ~ "Thomasnet", 
    is.na(thomasnet) ~ "Not on Thomasnet"
  ), 
  am = case_when(
    amma == 1 ~ "Amma Member", 
    TRUE ~ "Not Amma Member")) %>% 
  filter(tn == "Thomasnet") %>% 
  group_by(am, firm_size, size_pos) %>% 
  summarise(total = sum(n)) %>% 
  ggplot() + 
  geom_col(aes(x = am, y = total, group = reorder(firm_size, size_pos), fill = reorder(firm_size, size_pos)), position = "stack", color = "black") +
  guides(fill = FALSE) + 
  scale_fill_manual(values = size_col) + 
  scale_y_continuous(limits = c(0, 120)) + 
  coord_flip() + 
  labs(x = "", y = "") + 
  theme_bw() + 
  theme(axis.text = element_text(size = 12), 
        axis.text.y = element_blank()) 
```

```{r}
sample_size_b <- sample_count %>% 
  mutate(tn = case_when(
    thomasnet == 1 ~ "Thomasnet", 
    is.na(thomasnet) ~ "Not on Thomasnet"
  ), 
  am = case_when(
    amma == 1 ~ "Amma Member", 
    TRUE ~ "Not Amma Member")) %>% 
  filter(tn != "Thomasnet") %>% 
  group_by(am, firm_size, size_pos) %>% 
  summarise(total = sum(n)) %>% 
  ggplot() + 
  geom_col(aes(x = am, y = total, group = reorder(firm_size, size_pos), fill = reorder(firm_size, size_pos)), position = "stack", color = "Black") +
  scale_fill_manual(values = size_col) +
  scale_y_continuous(limits = c(0, 120)) + 
  coord_flip() + 
  labs(x = "", y = "Number of Companies") + 
  theme_bw() + 
  theme(axis.text = element_text(size = 12), 
        axis.text.y = element_blank()) + 
  guides(fill = FALSE)
```
```{r}
sample_size <- sample_size_a / sample_size_b
```


##### Company Timelines 

```{r}
company_timelines <- matched_sample %>% 
  group_by(company) %>% 
  mutate(min_reg = min(c(niosh, fda_510, eua), na.rm = TRUE)) %>% 
  filter(dom_useful_num == 1 | niosh_counter == TRUE | fda_counter == TRUE | contract_counter == TRUE | interview == 1) %>% 
  ggplot() + 
  geom_point(aes(x = min_date, y = reorder(company, sales_dbh)), size = 2) + 
  geom_point(shape = 21, fill = "Light Blue", aes(x = min_aff, y = reorder(company, sales_dbh)), size = 2) +
  geom_point(shape = 22, aes(x = niosh, y = reorder(company, sales_dbh)), fill = "blue", size = 2) + 
  geom_point(shape = 22, alpha = 0.7, aes(x = fda_510, y = reorder(company, sales_dbh)), fill = "purple", size = 2) + 
  geom_point(shape = 22, aes(x = eua, y = reorder(company, sales_dbh)), fill = "purple", alpha = 0.5, size = 2) + 
  geom_point(aes(x = first_contract, y = reorder(company, sales_dbh)), shape = 21, fill = "orange", alpha = 0.7, size = 2) +
  scale_x_date(date_labels = "%b, %y", breaks = "month") + 
  theme_bw() + 
  theme(axis.text.y = element_blank(), 
        axis.text.x = element_text(angle = 60, hjust = 1)) + 
  labs(x= "", y = "") 
```

```{r}
reg_line <- matched_sample %>%
  filter(niosh_counter == TRUE | fda_counter == TRUE) %>% 
  group_by(company) %>% 
  mutate(min_reg = min(c(niosh, fda_510, eua), na.rm = TRUE))
```

```{r}
com_time_reg <- company_timelines + 
  geom_segment(data = reg_line, aes(x = min_date, y = reorder(company, sales_dbh), xend = min_reg, yend = reorder(company, sales_dbh)))
```

## Thomasnet Validation Graphs

```{r}
validated <- matched_states %>% 
  filter(broad_product == "End Product") %>% 
  mutate(firm_size = case_when(
    sales_dbh < 1000000 ~ "Under $1 Mil", 
    sales_dbh >= 1000000 & sales_dbh < 10000000 ~ "$1M-$10M", 
    sales_dbh >= 10000000 & sales_dbh < 50000000 ~ "$10M-$50M", 
    sales_dbh >= 50000000 & sales_dbh < 1000000000 ~ "$50M-$1B", 
    sales_dbh >= 1000000000 ~ "$1B + "
  ), 
  size_pos = case_when(
    sales_dbh < 1000000 ~ 5, 
    sales_dbh >= 1000000 & sales_dbh < 10000000 ~ 4, 
    sales_dbh >= 10000000 & sales_dbh < 50000000 ~ 3, 
    sales_dbh >= 50000000 & sales_dbh < 1000000000 ~ 2, 
    sales_dbh >= 1000000000 ~ 1
  )) %>% 
  mutate(dom_useful = case_when(
    interview == 1 ~ 1, 
    dom_useful_num == -2 & (niosh_counter == TRUE | fda_counter == TRUE | contract_counter == TRUE) ~ 1,
    TRUE ~ dom_useful_num
  )) %>% 
  filter(!is.na(dom_useful), dom_useful > -2) 
```

```{r}
val_count <- validated %>% 
  mutate(dom_useful = as.factor(dom_useful), month = month(min_date, label = TRUE), year = year(min_date), 
  month_year = paste(month, substr(year, 3, 4), sep = ", ")) %>%
  group_by(month_year, month, year, dom_useful) %>% 
  count() %>% 
  mutate(ddate =  make_date(year = year, month = month, day = 01)) %>% 
  mutate(dom_use = case_when(
    dom_useful == 1 ~ "Affirmatively", 
    dom_useful == 0 ~ "No", 
    dom_useful == -1 ~ "Unknown"
  )) %>% 
  select(ddate, dom_use, n) %>% 
  pivot_wider(id_cols = c("ddate"), names_from = "dom_use", values_from = n) %>% 
  mutate(Affirmatively = replace_na(Affirmatively, 0), 
         No = replace_na(No, 0), 
         Unknown = replace_na(Unknown, 0)) %>% 
  filter(!is.na(ddate)) %>% 
  pivot_longer(cols = -c("ddate"), names_to = "dom_useful", values_to = "n") %>% 
  group_by(dom_useful) %>% 
  arrange(ddate) %>% 
  mutate(cumu_firms = cumsum(n), 
         dom_pos = case_when(
           dom_useful == "Affirmatively" ~ 1, 
           dom_useful == "Unknown" ~ 2, 
           dom_useful == "No" ~ 3
         )) %>% 
  filter(ddate < mdy("10/01/21"))
```


```{r}
val_colors <- c(brewer.pal(9, "Set3")[9], brewer.pal(9, "Greys")[7], brewer.pal(9, "Set3")[1])
```

```{r}
val_base <- val_count %>% 
  ggplot() + 
  geom_col(aes(x = ddate, y = cumu_firms, group = reorder(dom_useful, -dom_pos), fill = reorder(dom_useful, -dom_pos)), show.legend = FALSE, width = 31) + 
  scale_fill_manual(values = val_colors) + 
  scale_x_date(date_labels = "%b", breaks = "month") + 
  theme_minimal() + 
  theme(axis.text.y = element_text(size =14), 
        axis.text.x = element_text(size =14)) + 
  labs(x = "", y = "")
```

Ontop of cumsum graph stack real-time entries 

```{r, eval = FALSE}
val_1 <- validated  %>% 
  group_by(company) %>% 
  mutate(min_reg = min(c(niosh, fda_510, eua), na.rm = TRUE)) %>% 
  group_by(dom_useful) %>%
  ggplot() + 
  geom_histogram(color = "black", aes(x = min_date, y = cumsum(..count..), group = dom_useful, fill = as.factor(dom_useful)), alpha = 0.7, binwidth =  15, position = position_stack(vjust = 2), show.legend = FALSE) + 
  scale_fill_manual(values = val_colors) + 
  scale_x_date(date_labels = "%b, %y", breaks = "month") + 
  theme_minimal() + 
  theme(axis.text.y = element_text(size =14), 
        axis.text.x = element_text(size =14, angle = 60, hjust = 1)) + 
  labs(x = "", y = "")
```

```{r}
val_dom <- validated %>% 
  filter(dom_useful == 1) %>% 
  mutate(month = month(min_date, label = TRUE), year = year(min_date), 
  month_year = paste(month, substr(year, 3, 4), sep = ", ")) %>%
  group_by(month_year, month, year, firm_size, size_pos) %>% 
  count() %>% 
  mutate(ddate =  make_date(year = year, month = month, day = 01)) %>% 
  select(ddate, firm_size, n) %>% 
  pivot_wider(id_cols = c("ddate"), names_from = "firm_size", values_from = n) %>% 
  mutate(across(where(is.numeric), ~replace_na(., 0))) %>% 
  pivot_longer(cols = -c("ddate"), names_to = "firm_size", values_to = "n") %>% 
  group_by(firm_size) %>% 
  arrange(ddate) %>% 
  mutate(cumu_firms = cumsum(n), 
         size_pos = case_when(
    firm_size == "Under $1 Mil" ~ 5,
    firm_size == "$1M-$10M" ~ 4, 
    firm_size == "$10M-$50M" ~ 3, 
    firm_size == "$50M-$1B" ~ 2, 
    firm_size == "$1B + " ~ 1 
  ), 
  firm_size = case_when(
    firm_size == "NA" ~ NA_character_, 
    TRUE ~ firm_size
  )) %>% 
  filter(ddate < mdy("10/01/2021"))
```

```{r}
val_fix <- val_dom %>% 
  filter(ddate == mdy("08/01/2021")) %>% 
  mutate(ddate = mdy("09/01/2021")) %>% 
  bind_rows(val_dom)
```



```{r}
size_col <- c(brewer.pal(9, "Blues")[9], brewer.pal(9, "Blues")[7], brewer.pal(9, "Blues")[6], brewer.pal(9, "Blues")[4], brewer.pal(9, "Blues")[3])
```

```{r}
val_size <- val_base + 
  new_scale_fill() + 
  geom_col(data = val_fix, aes(x = ddate, y = cumu_firms, group = reorder(firm_size, size_pos), fill = reorder(firm_size, size_pos)), width = 31, color = "Black") +
  scale_fill_manual(values = size_col, na.value = "White") + 
  labs(fill = "") + 
  guides(fill = FALSE, color = FALSE)
```

```{r}
leg <- ggplot() + 
  geom_col(data = val_fix, aes(x = ddate, y = cumu_firms, group = reorder(firm_size, size_pos), fill = reorder(firm_size, size_pos)), color = "Black") + 
  scale_fill_manual(values = size_col, na.value = "White") + 
  labs(fill = "") + 
  theme_minimal() +  
  guides(fill = guide_legend(nrow = 1)) +
  theme(legend.position = "bottom")
```


```{r}
val_2 <- val_1 + 
  new_scale_fill() + 
  geom_histogram(data = val_dom, color = "black", aes(x = min_date, y = cumsum(..count..), group = reorder(firm_size, size_pos), fill = reorder(firm_size, size_pos)), binwidth =  15, position = position_stack(vjust = 2)) +
  scale_fill_manual(values = size_col, na.value = "White") + 
  labs(fill = "")
```

```{r}
val_leg <- val_2 + labs(fill = "Domestic Manufacturer Firm Size")
```

```{r}
geom_histogram(color = "black", aes(x = min_reg), fill = brewer.pal(9, "BuPu")[2], binwidth =  15, position = position_stack(vjust = 2)) +
```

```{r}
validates %>% 
  mutate(firm_size = case_when(
    sales_dbh < 1000000 ~ "Under $1 Mil", 
    sales_dbh >= 1000000 & sales_dbh < 10000000 ~ "$1M-$10M", 
    sales_dbh >= 10000000 & sales_dbh < 50000000 ~ "$10M-$50M", 
    sales_dbh >= 50000000 & sales_dbh < 1000000000 ~ "$50M-$1B", 
    sales_dbh >= 1000000000 ~ "$1B + "
  ), 
  size_pos = case_when(
    sales_dbh < 1000000 ~ 5, 
    sales_dbh >= 1000000 & sales_dbh < 10000000 ~ 4, 
    sales_dbh >= 10000000 & sales_dbh < 50000000 ~ 3, 
    sales_dbh >= 50000000 & sales_dbh < 1000000000 ~ 2, 
    sales_dbh >= 1000000000 ~ 1
  ), 
  month = month(ddate, label = TRUE), year = year(ddate), 
  month_year = paste(month, substr(year, 3, 4), sep = ", ")) %>%
  group_by(firm_size, month_year, month, year, reg_type, reg_pos, size_pos) %>% 
  count() %>% 
  mutate(ddate =  make_date(year = year, month = month, day = 01))
```

```{r}
validated %>% 
  group_by(dom_useful) %>%
  ggplot() + 
  stat_binline(color = "black", aes(x = min_date, y =  as.factor(dom_useful), group = dom_useful, fill = as.factor(dom_useful)), stat = cumsum(..count..), scale = 2.2, alpha = 0.7, stat = "binline", binwidth =  15) + 
  scale_x_date(date_labels = "%b, %y", breaks = "month")  
```
## State Graphs

```{r}
short_col <- c(brewer.pal(9, "Set1")[3], brewer.pal(8, "Accent")[3], brewer.pal(9, "Set1")[1])
```

```{r}
state_graph <- matched_states %>% 
  filter(dom_useful_num == 1 | niosh_counter == TRUE | fda_counter == TRUE | contract_counter == TRUE | interview == 1, sales_dbh < 1000000000) %>% 
  mutate(shortage = case_when(
    min_date_all < mdy("06/01/2020") ~ "Intense", 
    min_date_all >= mdy("06/01/2020") & min_date_all < mdy("09/01/2020") ~ "Resuming", 
    min_date_all > mdy("09/01/2020") ~ "Normalized"
  ), 
  short_pos = case_when(
    shortage == "Intense" ~ 1, 
    shortage == "Resuming" ~ 2, 
    shortage == "Normalized" ~ 3, 
  )) %>% 
  group_by(state_abbr, shortage, short_pos) %>% 
  count() %>% 
  group_by(state_abbr) %>% 
  mutate(total = sum(n)) %>% 
  ggplot() + 
  geom_col(aes(x = n, y = reorder(state_abbr, total), group = reorder(shortage, -short_pos), fill = reorder(shortage, short_pos))) + 
  scale_fill_manual(values = short_col) +
  theme_bw() + 
  labs(x = "Companies", y = "", fill = "Period of Shortages") + 
  theme(legend.position = "top") 
```

```{r}
state_reg_col <- c(brewer.pal(9, "Purples")[3], brewer.pal(12, "Set3")[10], brewer.pal(9, "Purples")[6])
```


```{r}
state_reg_graph <- matched_states %>% 
  filter(dom_useful_num == 1 | niosh_counter == TRUE | fda_counter == TRUE | contract_counter == TRUE | interview == 1, sales_dbh < 1000000000, broad_product == "End Product") %>% 
  mutate(reg_appr = case_when(
    niosh_counter == 1 & fda_counter == 1 ~ "NIOSH ahd FDA Approval",
    niosh_counter == 1 & fda_counter == FALSE ~ "NIOSH Approval Only", 
    niosh_counter == FALSE & fda_counter == TRUE ~ "FDA Approval Only")) %>% 
  group_by(state_abbr, reg_appr) %>% 
  count() %>% 
  group_by(state_abbr) %>% 
  mutate(reg_counter = case_when(
    !is.na(reg_appr) ~ 1, 
    is.na(reg_appr) ~ 0
  ),
    total_appr = sum(n*reg_counter), 
  total = sum(n), 
  appr_perc = paste(round(total_appr/total * 100), "%", sep = "")) %>% 
  ggplot() + 
  geom_col(aes(x = n, y = reorder(state_abbr, total), group = reg_appr, fill = reg_appr), show.legend = FALSE) + 
  scale_fill_manual(values = state_reg_col, na.value = brewer.pal(9, "Set3")[1]) + 
  theme_bw() + 
  labs(x = "Companies", y = "", fill = "Regulatory Appproval") + 
  theme(legend.position = "top", 
        axis.text = element_text(size = 14)) 
```

```{r}
state_reg_graph_label <- state_reg_graph +   geom_label(aes(x = total, y = reorder(state_abbr, total), label = appr_perc), size = 7, fill = brewer.pal(9, "Purples")[5]) + 
```

```{r}
timing_test <- matched_states %>% 
   filter(dom_useful_num == 1 | niosh_counter == TRUE | fda_counter == TRUE | contract_counter == TRUE | interview == 1, sales_dbh < 1000000000, broad_product == "End Product") %>% 
  mutate(reg_appr = case_when(
    niosh_counter == 1 & fda_counter == 1 ~ "NIOSH ahd FDA Approval",
    niosh_counter == 1 & fda_counter == FALSE ~ "NIOSH Approval Only", 
    niosh_counter == FALSE & fda_counter == TRUE ~ "FDA Approval Only")) %>% 
  mutate(shortage = case_when(
    min_date_all < mdy("06/01/2020") ~ "Intense", 
    min_date_all >= mdy("06/01/2020") & min_date_all < mdy("09/01/2020") ~ "Resuming", 
    min_date_all > mdy("09/01/2020") ~ "Normalized"
  ), 
  short_pos = case_when(
    shortage == "Intense" ~ 1, 
    shortage == "Resuming" ~ 2, 
    shortage == "Normalized" ~ 3, 
  )) %>% 
  group_by(state_abbr, shortage, short_pos, reg_appr) %>% 
  count() %>% 
  group_by(state_abbr) %>% 
  mutate(reg_counter = case_when(
    !is.na(reg_appr) ~ 1, 
    is.na(reg_appr) ~ 0
  ),
    total_appr = sum(n*reg_counter), 
  total = sum(n), 
  appr_perc = paste(round(total_appr/total * 100), "%", sep = ""))
```


```{r}
reg_timing <- state_reg_graph + 
  new_scale_fill()+
  geom_col(data = timing_test, aes(x = n, y = reorder(state_abbr, total), group = reorder(shortage, -short_pos), fill = reorder(shortage, short_pos)), show.legend = FALSE) + 
  geom_label(data = timing_test, aes(x = total, y = reorder(state_abbr, total), label = appr_perc), size = 7, fill = brewer.pal(9, "Purples")[5]) +
  scale_fill_manual(values = short_col) 
  
```

```{r}
size_test <- matched_states %>% 
  filter(dom_useful_num == 1 | niosh_counter == TRUE | fda_counter == TRUE | contract_counter == TRUE | interview == 1, sales_dbh < 1000000000, broad_product == "End Product") %>% 
  mutate(firm_size = case_when(
    sales_dbh < 1000000 ~ "Under $1 Mil", 
    sales_dbh >= 1000000 & sales_dbh < 10000000 ~ "$1M-$10M", 
    sales_dbh >= 10000000 & sales_dbh < 50000000 ~ "$10M-$50M", 
    sales_dbh >= 50000000 & sales_dbh < 1000000000 ~ "$50M-$1B", 
    sales_dbh >= 1000000000 ~ "$1B + "
  ), 
  size_pos = case_when(
    sales_dbh < 1000000 ~ 5, 
    sales_dbh >= 1000000 & sales_dbh < 10000000 ~ 4, 
    sales_dbh >= 10000000 & sales_dbh < 50000000 ~ 3, 
    sales_dbh >= 50000000 & sales_dbh < 1000000000 ~ 2, 
    sales_dbh >= 1000000000 ~ 1)) %>% 
   mutate(reg_appr = case_when(
    niosh_counter == 1 & fda_counter == 1 ~ "NIOSH ahd FDA Approval",
    niosh_counter == 1 & fda_counter == FALSE ~ "NIOSH Approval Only", 
    niosh_counter == FALSE & fda_counter == TRUE ~ "FDA Approval Only")) %>% 
  group_by(state_abbr, firm_size, size_pos, reg_appr) %>% 
  count() %>% 
  group_by(state_abbr) %>% 
  mutate(reg_counter = case_when(
    !is.na(reg_appr) ~ 1, 
    is.na(reg_appr) ~ 0
  ),
    total_appr = sum(n*reg_counter), 
  total = sum(n), 
  appr_perc = paste(round(total_appr/total * 100), "%", sep = ""))
```

```{r}
size_col1 <- c(brewer.pal(9, "Blues")[7], brewer.pal(9, "Blues")[6], brewer.pal(9, "Blues")[4], brewer.pal(9, "Blues")[3])
```


```{r}
state_size <- state_reg_graph + 
  new_scale_fill()+
  geom_col(data = size_test, aes(x = n, y = reorder(state_abbr, total), group = reorder(firm_size, size_pos), fill = reorder(firm_size, size_pos)), show.legend = FALSE) + 
  geom_label(data = size_test, aes(x = total, y = reorder(state_abbr, total), label = appr_perc), size = 7, fill = brewer.pal(9, "Purples")[5]) + 
  scale_fill_manual(values = size_col1) 
```

## GRAPHS FOR PAPER! 


```{r}
aff_dom <- all_dom %>% 
  filter(!is.na(dom_useful)) %>% 
  mutate(dom_useful = case_when(
    dom_useful == "0" ~ "No", 
    dom_useful == "Possibly" ~ "Unknown", 
    dom_useful == "1" ~ "Yes"
  )) %>% 
  filter(broad_product == "End Product") %>% 
  group_by(date, dom_useful) %>% 
  count() %>% 
  ungroup() %>% 
  pivot_wider(c(date), names_from = dom_useful, values_from = n, values_fill = 0)
    #%>% 
  #mutate(n = case_when(
           #pos == 2 & date == ymd("2020-09-08") ~ 9,
           #pos == 2 & date != ymd("2020-09-08") ~ as.double(n), 
         #pos != 2 ~ as.double(n)))
```

```{r}
val_fig <- aff_dom %>% 
  ggplot() + 
  geom_area(aes(date, No + Unknown + Yes), position = "stack", fill = "#1f1f1f", color = "White") +
  geom_area(aes(date, Yes + Unknown), position = "stack", fill = "Light Grey", color = "White") + 
  geom_area(aes(date, Yes), position = "stack", fill = "Light Blue", color = "White") + 
  
  geom_line(aes(date, Yes), size = 1.3, position = "stack", show.legend = FALSE) +
  geom_point(aes(date, Yes), position = "stack", shape = 21, size = 2, fill = "Light Blue", color = "Black", alpha = 0.75) +

  scale_x_date(date_labels = "%b", breaks = "month") + 
  scale_y_continuous(breaks = seq(0,300, by = 50)) + 
  labs(x = "", y = "") + 
  theme_classic() + 
  theme(axis.text.y = element_text(size = 18), axis.text.x = element_text(size = 12, angle= 45, hjust = 1))
```



### Building our first timeline graph

We utilize this matched data to construct our first timeline of confirmed domestic entries. 

```{r}
match1_clean <- match1_clean %>% 
  mutate(dom_useful_num = case_when(
    str_detect(company, "3M") | str_detect(company, "Honeywell") | str_detect(company, "Halyard") | str_detect(company, "Moldex") | str_detect(company, "Kimberly-Clark") ~ 1,
    TRUE ~ dom_useful_num
  ))
```

```{r}
base_timeline <- match1_clean %>% 
  filter(dom_useful_num == 1, !specific_product %in% c("No Latex Elastic", "Cloth Masks", "Non-Woven Fabric")) %>% 
  group_by(company) %>% 
  mutate(tal = seq(n()), 
         min_date_tn = min(min_date, na.rm = TRUE), 
         address = case_when(
           is.na(address) & !is.na(address_man) ~ address_man, 
           TRUE ~ address
         ), 
         date_int = as.integer(min_date_tn)) %>% 
  filter(tal == 1) %>% 
  ggplot() + 
  geom_point(aes(x= min_date_tn, y = reorder(company, date_int)))
```

# Matching with Regulatory Data

We now bring in FDA 510K and NIOSH data to merge with our existing data. We want to simplify our previous data structure to have a unique entry per company and to keep the minimum date a firm was observed, as well as the source they were identified in. 

```{r}
company_list1 <- match1_clean %>% 
  group_by(company) %>% 
  mutate(tal = seq(n()), 
         min_date_tn = min(min_date, na.rm = TRUE), 
         address = case_when(
           is.na(address) & !is.na(address_man) ~ address_man, 
           TRUE ~ address
         )) %>% 
  filter(tal == 1) %>% 
  select(company, address, location, thomasnet, amma, dom_useful_num, manf_loc, min_date_tn, dom_useful_mark)
```


## Bring in FDA 510k data

We now bring in our FDA 510K data. 

```{r}
fda_formatch <- readRDS(box_here("FDA/fda_formatch.RDS"))
```

We then clean the company names, simplify the FDA data to provide company level information, and match what data we can. 

```{r}
match_fda <- fda_formatch %>% 
  filter(product %in% c("Surgical Respirator", "Surgical Face Mask")) %>% 
  mutate(fda = 1) %>% 
  rename(company = APPLICANT) %>% 
  mutate(company = case_when(
    company == "FSSC, LLC" ~ "Indiana Face Mask", 
    TRUE ~ company
  ),
    company = case_when(
    str_detect(company, "3M") ~ "3M", 
    TRUE ~ company
  ),
  company = case_when(
    str_detect(company, "CustomFab") ~ "CustomFab USA, Inc.", 
    TRUE ~ company
  ),
  company = case_when(
    str_detect(company, "Defender Safety") ~ "Defender Safety Inc", 
    TRUE ~ company
  ),
  company = case_when(
    str_detect(company, "DemeTECH Corporation") ~ "DemeTech Corporation", 
    TRUE ~ company
  ),
  company = case_when(
    str_detect(company, "EcoGuard Inc.") ~ "Ecoguard", 
    TRUE ~ company
  ),
  company = case_when(
    str_detect(company, "Premier Guard USA LLC") ~ "Premier Guard USA", 
    TRUE ~ company
  ),
  company = case_when(
    str_detect(company, "SQ Medical Supplies") ~ "SQ Medical Supplies", 
    TRUE ~ company
  ),
  company = case_when(
    str_detect(company, "Unisources Group LLC") ~ "UNISOURCES GROUP", 
    TRUE ~ company
  ),
  company = case_when(
    str_detect(company, "United Sewing Automation Inc.") ~ "United Sewing Automation, Inc.", 
    TRUE ~ company
  ),
  ) %>% 
  mutate(fda_address = paste(STREET1, CITY, STATE, ZIP)) %>% 
  select(company, DATERECEIVED, DECISIONDATE, TYPE, device, product, PRODUCTCODE, fda, fda_address, COUNTRY_CODE) 
```

```{r}
simple_fda <- match_fda %>%
    group_by(company) %>% 
  mutate(first_fda = min(mdy(DECISIONDATE)),
         last_fda = max(mdy(DECISIONDATE)),
         total_fda = n(), 
         mean_delay = mean(mdy(DECISIONDATE) - mdy(DATERECEIVED)), 
         tal = seq(n())) %>% 
  filter(tal == 1) %>% 
  select(company, first_fda, last_fda, total_fda, mean_delay, fda, fda_address, COUNTRY_CODE) %>% 
  filter(year(last_fda) > 2019)
```

```{r}
company_list2 <- full_join(company_list1, simple_fda, by = c("company")) %>% 
  mutate(address = case_when(
    is.na(address) & !is.na(fda_address) ~ fda_address, 
    TRUE ~ address
  ))
```


#### FDA Graph

```{r}
match_fda %>% 
  mutate(DATERECEIVED = mdy(DATERECEIVED), 
         DECISIONDATE = mdy(DECISIONDATE), 
         delay = DECISIONDATE - DATERECEIVED) %>% 
  filter(COUNTRY_CODE == "US", year(DATERECEIVED) > 2019) %>% 
  left_join(company_list1) %>% 
  ggplot() + 
  geom_point(aes(x = DATERECEIVED, y = reorder(company, delay))) + 
  geom_point(aes(x = DECISIONDATE, y =reorder(company, delay))) + 
  geom_segment(aes(x = DATERECEIVED, xend = DECISIONDATE, y = reorder(company, delay), yend = reorder(company, delay)))
```


## Bring in NIOSH data 

```{r}
niosh_manf_info <- readRDS(box_here("/FDA/niosh_manf_info.RDS"))
```


```{r}
niosh_formatch <- readRDS(box_here("FDA/niosh_clean.RDS"))
```

```{r}
match_niosh <- niosh_formatch %>% 
  mutate(company = case_when(
    str_detect(company, "3M") ~ "3M", 
    TRUE ~ company
  ),
  company = case_when(
    str_detect(company, "Advoque") ~ "Advoque Safeguard", 
    TRUE ~ company
  ),
  company = case_when(
    str_detect(company, "Aidway Personal Care") ~ "Aidway Personal Care Product Inc.", 
    TRUE ~ company
  ), 
  company = case_when(
    str_detect(company, "DemeTECH Corporation") ~ "DemeTech Corporation", 
    TRUE ~ company
  ),
  company = case_when(
    str_detect(company, "Draeger") | str_detect(company, "Safety AG & Company") ~ "Draeger Inc.", 
    TRUE ~ company
  ),
   company = case_when(
    str_detect(company, "Ford Motor") ~ "Ford Motor Co.", 
    TRUE ~ company
  ),
  company = case_when(
    str_detect(company, "Indiana Face Mask") ~ "Indiana Face Mask", 
    TRUE ~ company
  ),
  company = case_when(
    str_detect(company, "Global Saftey First") ~ "Global Saftey First, LLC", 
    TRUE ~ company
  ),
  company = case_when(
    str_detect(company, "Honeywell") ~ "Honeywell Safety Products", 
    TRUE ~ company
  ),
  company = case_when(
    str_detect(company, "Kimberly") ~ "Kimberly-Clark Professional", 
    TRUE ~ company
  ),
  company = case_when(
    str_detect(company, "Gerson") ~ "Louis M. Gerson Co., Inc.", 
    TRUE ~ company
  ),
  company = case_when(
    str_detect(company, "Makrite") ~ "Makrite", 
    TRUE ~ company
  ),
  company = case_when(
    str_detect(company, "Moldex") ~ "Moldex", 
    TRUE ~ company
  ),
  company = case_when(
    str_detect(company, "Pandmedic") ~ "PandMedic Solutions", 
    TRUE ~ company
  ),
  company = case_when(
    str_detect(company, "Protective Health Gear") ~ "Protective Health Gear", 
    TRUE ~ company
  ),
  company = case_when(
    str_detect(company, "United States Mask") ~ "United States Mask", 
    TRUE ~ company
  ), 
  company = case_when(
    str_detect(company, "GVS Filter Technology UK, Ltd.") ~ "GVS North America", 
    TRUE ~ company
  ), 
  company = case_when(
    str_detect(company, "Shawmut") ~ "Shawmut Corporation", 
    TRUE ~ company)) %>% 
  mutate(niosh = 1, 
         appr_date = mdy(appr_date)) %>% 
  filter(!is.na(appr_date)) %>% 
  filter(year(appr_date) > 2019) %>% 
  select(company, niosh_prod = specific_product, approval_num, appr_date, private_label, private_company_prnt, products, companies, niosh)
```

```{r}
niosh_simple <- match_niosh %>% 
  group_by(company) %>% 
  mutate(first_niosh = min(appr_date),
         last_niosh = max(appr_date),
         total_niosh = n(), 
         tal = seq(n())) %>% 
  filter(tal == 1) %>% 
  select(company, first_niosh, last_niosh, total_niosh, niosh)
```


```{r}
company_list3 <- full_join(company_list2, niosh_simple, by = c("company"))
```

```{r}
company_list3 %>% 
  filter(is.na(COUNTRY_CODE) | COUNTRY_CODE == "US") %>% 
  group_by(dom_useful_mark) %>% 
  summarise(thomasnet = sum(thomasnet, na.rm = TRUE), 
            amma = sum(amma, na.rm = TRUE), 
            fda = sum(fda, na.rm = TRUE), 
            niosh = sum(niosh, na.rm = TRUE)) %>% 
  write_csv(box_here("sample_checking.csv"))
```

```{r}
company_list3 %>% 
  filter(is.na(COUNTRY_CODE) | COUNTRY_CODE == "US") %>% 
  group_by(fda) %>% 
  summarise(thomasnet = sum(thomasnet, na.rm = TRUE), 
            amma = sum(amma, na.rm = TRUE), 
            fda = sum(fda, na.rm = TRUE), 
            niosh = sum(niosh, na.rm = TRUE)) 
```

```{r}
write.csv(company_list3, box_here("manf_company_list.csv"))
```


```{r}
match3 <- full_join(match2, match_niosh, by = c("company"))
```

```{r}
match3 %>% 
  group_by(company) %>% 
  mutate(tal = seq(n())) %>% 
  filter(tal == 1) %>% 
  select(company, address, location, thomasnet, amma, niosh) %>% 
  view()
  
```


## Bring in Contracts

### Federal Contracts 

```{r}
fed_primes <- read_csv(box_here("Contracts/fed_prime.csv"))
fed_subs <- read_csv(box_here("Contracts/fed_subs.csv"))
```
```{r}
fed_primes_simple <- fed_primes %>% 
  select(recipient_name, parent_award_agency_name, award_id_piid, federal_action_obligation, total_dollars_obligated, action_date, awarding_agency_name, period_of_performance_start_date, period_of_performance_current_end_date, solicitation_date, awarding_sub_agency_name, recipient_state_name, primary_place_of_performance_state_name, domestic_or_foreign_entity, place_of_manufacture, organizational_type, award_description) %>% 
  filter(str_detect(award_description, fixed("oxygen", ignore_case = TRUE), negate = TRUE)) %>% 
  filter(str_detect(award_description, fixed("panel", ignore_case = TRUE), negate = TRUE)) %>%
  filter(str_detect(award_description, fixed("masking", ignore_case = TRUE), negate = TRUE)) %>% 
  filter(str_detect(award_description, fixed("physicals", ignore_case = TRUE), negate = TRUE)) %>% 
  filter(str_detect(award_description, fixed("plethysmograph", ignore_case = TRUE), negate = TRUE))  %>% 
  filter(str_detect(award_description, fixed("liner", ignore_case = TRUE), negate = TRUE)) %>% 
  filter(str_detect(award_description, fixed("anesthesia", ignore_case = TRUE), negate = TRUE)) %>% 
  filter(str_detect(award_description, fixed("molecule", ignore_case = TRUE), negate = TRUE)) %>% 
  filter(str_detect(award_description, fixed("helmet, welder", ignore_case = TRUE), negate = TRUE)) %>% 
   filter(str_detect(award_description, fixed("wipes", ignore_case = TRUE), negate = TRUE)) %>%
  filter(str_detect(award_description, fixed("regulator", ignore_case = TRUE), negate = TRUE)) %>% 
  filter(str_detect(award_description, fixed("canister", ignore_case = TRUE), negate = TRUE)) %>% 
  filter(str_detect(award_description, fixed("masker", ignore_case = TRUE), negate = TRUE)) %>% 
  filter(str_detect(award_description, fixed("tape", ignore_case = TRUE), negate = TRUE)) %>%
  filter(str_detect(award_description, fixed("behalf", ignore_case = TRUE), negate = TRUE)) %>%
  filter(str_detect(award_description, fixed("sanitiz", ignore_case = TRUE), negate = TRUE)) %>% 
  filter(str_detect(award_description, fixed("assembly", ignore_case = TRUE), negate = TRUE)) %>% 
  filter(str_detect(award_description, fixed("tube", ignore_case = TRUE), negate = TRUE)) %>% 
  filter(str_detect(award_description, fixed("lens", ignore_case = TRUE), negate = TRUE)) %>% 
  filter(str_detect(award_description, fixed("prosthetics", ignore_case = TRUE), negate = TRUE)) %>% 
  mutate(test = str_detect(award_description, fixed("test", ignore_case = TRUE)), 
         cloth = str_detect(award_description, fixed("cloth", ignore_case = TRUE)),
         ventilator = str_detect(award_description, fixed("ventilator", ignore_case = TRUE)))

view(fed_primes_simple)
```

```{r}
fed_primes_simple %>% 
  filter(str_detect(recipient_name, "HONEYWELL"), str_detect(recipient_name, "AEROSPACE", negate = TRUE)) %>% 
  group_by(recipient_name) %>% 
  summarise(total_dollars = sum(total_dollars_obligated))
```

```{r}
fed_primes_simple %>% 
  filter(test == FALSE, cloth == FALSE, ventilator == FALSE, place_of_manufacture == "MFG IN U.S.") %>% 
  mutate(product_spec = case_when(
    str_detect(award_description, "SURGICAL") |
      str_detect(award_description, "PROCEDURE") |str_detect(award_description, "3-PLY") | str_detect(award_description, "3 PLY") | str_detect(award_description, "LEVEL")  ~ "Surgical or 3-Ply Mask (ASTM 1, 2, or 3)", 
    str_detect(award_description, "N95") | str_detect(award_description, "N-95") ~ "N95 or KN95 Type Respirator", 
    str_detect(award_description, "PAPR") | str_detect(award_description, "CAPR") | str_detect(award_description, "NAPR") ~ "PAPR, CAPR, or NAPR", 
    str_detect(award_description, "ELASTOMERIC") ~ "Elastomeric", 
    str_detect(award_description, "GAS") | str_detect(award_description, "C50") ~ "Gas Mask", 
    str_detect(award_description, "DUST") | str_detect(award_description, "CLEANROOM")| str_detect(award_description, "R95") | str_detect(award_description, "8541") ~ "Dust, Cleanroom, or Other Respirator", 
  str_detect(award_description, "HALF") | str_detect(award_description, "7502") | str_detect(award_description, "7501") | str_detect(award_description, "7503") ~ "Half Mask Respirator",
  str_detect(award_description, "FULL FACE") ~ "Full Face Respirator", 
  str_detect(award_description, "MELTBLOWN") ~ "Meltblown"
  )) %>% 
  mutate(product_spec = case_when(
    is.na(product_spec) & str_detect(award_description, "3M") ~ "Other 3M Product", 
    is.na(product_spec) & str_detect(award_description, "DISPOS")
   ~ "Unspecified Disposable Mask or Respirator", 
   is.na(product_spec) & (str_detect(award_description, "MASK") | str_detect(award_description, "RESPIRATOR")) ~ "Unspecified Mask or Respirator", 
   is.na(product_spec) & str_detect(award_description, "PARTICULATE") ~ "Other Particulate Respirator", 
TRUE ~ product_spec)) %>% 
  filter(!is.na(product_spec)) %>% 
  mutate(broad_product = case_when(
    product_spec %in% c("Surgical or 3-Ply Mask (ASTM 1, 2, or 3)", "N95 or KN95 Type Respirator") ~ "Standard FDA Regulated Mask/Respirator", 
    product_spec %in% c("PAPR, CAPR, or NAPR", "Half Mask Respirator", "Full Face Respirator", "Elastomeric") ~ "Advanced, Reusable Respirators", 
    product_spec %in% c("Dust, Cleanroom, or Other Respirator") ~ "Industrial Saftey Respirator", 
    TRUE ~ "Other, Unspecified Mask/Respirator"
  )) %>% 
  view()
```


```{r}
fed_subs_simple <- fed_subs %>% 
  select(subawardee_name, subaward_description, subawardee_state_name, subaward_action_date, subaward_amount
, prime_awardee_name, prime_awardee_parent_name, prime_awardee_state_name, prime_award_awarding_agency_name, prime_award_funding_sub_agency_name, prime_award_unique_key, prime_award_piid) 

view(fed_subs_simple)
```

# Analysis 

Total Thomasnet End Products (By Usefulness)

```{r}
match3 %>% 
  filter(!specific_product %in% c("Non-Woven Fabric", "No Latex Elastic")) %>% 
  mutate(num_useful = case_when(
      useful == "Affirmatively" ~ 3,
      useful == "Possibly" ~ 2,
      useful == "Unknown" ~ 1,
      is.na(useful) ~ 0
    )) %>% 
  group_by(company) %>% 
  mutate(tal = seq(n())) %>% 
  filter(tal == 1) %>% 
  mutate(max_useful = max(num_useful, na.rm = TRUE)) %>% 
  mutate(useful = case_when(
    max_useful == 3 ~ "Affirmatively", 
    max_useful == 2 ~ "Possibly", 
    max_useful == 1 ~ "Unknown", 
    max_useful == 0 ~ "Missing"
  )) %>% 
  group_by(useful, max_useful) %>% 
  summarize(thomasnet = sum(thomasnet, na.rm = TRUE), 
            amma = sum(amma, na.rm = TRUE), 
            fda = sum(fda, na.rm = TRUE), 
            niosh = sum(niosh, na.rm = TRUE)) %>% 
      arrange(-max_useful) %>% 
  select(-max_useful) %>% 
  write_csv(box_here("sum1.csv"))
```

```{r}
match3 %>% 
  filter(!specific_product %in% c("Non-Woven Fabric", "No Latex Elastic")) %>%
  group_by(company) %>% 
  mutate(tal = seq(n()), 
         tot_prods = n()) %>% 
  filter(tal == 1) %>% 
  group_by(dom_useful_num) %>% 
  summarize(thomasnet = sum(thomasnet, na.rm = TRUE), 
            amma = sum(amma, na.rm = TRUE), 
            fda = sum(fda, na.rm = TRUE), 
            niosh = sum(niosh, na.rm = TRUE)) %>% 
  write_csv(box_here("sum2.csv"))
```


```{r}
match3 %>% 
  filter(dom_useful_num == 0) %>% 
  view()
```

```{r}
match3 %>% 
  group_by(dom_useful_num) %>% 
  summarize(thomasnet = sum(thomasnet, na.rm = TRUE), 
            amma = sum(amma, na.rm = TRUE), 
            fda = sum(fda, na.rm = TRUE), 
            niosh = sum(fda, na.rm = TRUE))
```


Total Matched With Thomasnet, AMMA, FDA, NIOSH, Gov Contracts 

# Geocoding


```{r, echo = FALSE, Include = FALSE}
api_key <- c("AIzaSyA1pwzK3BaX7_um-_TUrS7aGfCHQvp68b8")
```

We define our function, which will take an address as an input and output a latitude and longitude result. 

```{r}
geocodeAddress <- function(address) {
  require(RJSONIO)
  url <- "https://maps.googleapis.com/maps/api/geocode/json?address="
  url <- URLencode(paste(url, address, sep = ""))
  url <- URLencode(paste(url, "&key=", api_key, sep = ""))
  x <- fromJSON(url, simplify = FALSE)
  print(x$status)
  if (x$status == "OK") {
    out <- c(x$results[[1]]$geometry$location$lng,
             x$results[[1]]$geometry$location$lat,
             x$results[[1]]$formatted_address)
  } else {
    out <- NA
  }
  Sys.sleep(0.2)  # API only allows 5 requests per second
  out
}
```

```{r}
conf_fil <- function(data) {
  data %>% 
    filter(dom_useful == 1 | !is.na(DUNS)) %>% 
    filter(!dom_useful %in% c("0", "Possibly"))
}
``` 

```{r}
conf_fil(conf_fmresp) %>% 
  view()
```


```{r}
conf_all <- bind_rows(conf_nl, conf_nw) %>% 
  bind_rows(conf_resp) %>% 
  bind_rows(conf_fm) %>% 
  bind_rows(conf_fmresp)
```

```{r}
conf_all <-   conf_all %>% 
  mutate(iso_only = str_detect(confirmation, "ISO")) %>%
  mutate(dom_useful = case_when(
    iso_only == 1 & str_detect(confirmation, "China", negate = TRUE) ~ "Possibly", 
    TRUE ~ dom_useful
  )) %>% 
  conf_fil()
```

```{r}
conf_all_maps <- conf_all %>% 
   mutate(comp_address = paste(company, address, sep = ", ")) %>% 
    mutate(specific_product = if_else(company %in% c("Safe Health", "Luosh USA, LLC", "PandMedic Solutions", "Alpha Pro Tech, Ltd.", "Guardis Medical
", "Phenotype Pharmaceuticals"), "Respirators and Face Masks", specific_product),
specific_product = if_else(company %in% c("United States Mask"), "Respirators Only", specific_product),
specific_product = if_else(company %in% c("Guardis Medical", "Hero Life Sciences, Inc."), "Face Masks Only", specific_product)) %>% 
  group_by(company, address) %>% 
  mutate(tal = seq(n())) %>% 
  filter(tal == 1)
```

```{r, include = FALSE}
for(i in 1:nrow(conf_all_maps))
{
  result <- geocodeAddress(conf_all_maps$address[i])
  conf_all_maps$long[i] <- as.numeric(result[1])
  conf_all_maps$lat[i] <- as.numeric(result[2])
  conf_all_maps$form_address[i] <- as.character(result[3])

}
```

```{r}
conf_all_maps %>% 
  filter(form_address == "United States" | is.na(form_address)) %>%
  select(company, address, form_address, specific_product) %>% 
  view()
```

```{r}
conf_all_maps <- conf_all_maps %>% 
  mutate(broad_product = case_when(
    specific_product %in% c("Respirators Only", "Respirators and Face Masks", "Face Masks Only") ~ "End Product", 
    specific_product %in% c("Non-Woven Fabric", "No Latex Elastic") ~ "Intermediary Product"
    ))
```


```{r}
conf_all_maps %>% 
  saveRDS(box_here("thomasnet_totals/conf_manfs_geocoded.RDS"))
```

```{r}
conf_all_maps <- readRDS(box_here("thomasnet_totals/conf_manfs_geocoded.RDS"))
```


```{r}
conf_all_maps <- conf_all_maps %>%
  ungroup() %>% 
  group_by(company, specific_product) %>% 
  mutate(hq= case_when(
    str_detect(comp_type_dbh, "HQ") | str_detect(comp_type_dbh, "Private Independent") | (is.na(comp_type_dbh) & manf_loc == 1 & max(seq(n())) ==1 ) ~ "HQ" , 
    str_detect(comp_type_dbh, fixed("branch", ignore_case = TRUE)) | str_detect(comp_type_dbh, fixed("subsidiary", ignore_case = TRUE)) ~ "Branch or Subsidiary"),
    manf_hq = case_when(
      hq == "HQ" & (manf_loc == 0 | is.na(manf_loc)) ~ "HQ Only",
      hq == "HQ" & manf_loc == 1 ~ "Manufacturing Location and HQ",
      hq == "Branch or Subsidiary" & manf_loc == 1 ~ "Manufacturing Branch" , 
      is.na(hq) & manf_loc == 1 ~ "Manufacturing Location (UC)", 
      hq == "Branch or Subsidiary" & (manf_loc == 0 | is.na(manf_loc)) ~ "Branch or Subsidiary"
    ), 
    manf_hq = if_else(is.na(manf_hq), "Unknown", manf_hq)) %>% 
  ungroup()
```


## Preparing Data Fields for Mapping


```{r}
prepare_for_maps <- function(df) {
  df %>% 
    mutate(layerId = paste(manf_hq, row_number(), sep = '.'),
                      popup = paste("<strong>Company Name:</strong>",
                                    df$company, "<br>",
                                    "<strong>Country of Ownership:</strong>",
                                    df$parent_ownership, "<br>",
                                    "<strong>Manufacturing Location?</strong>", 
                                    df$manf_loc, "<br>",
                                    "<strong>(DBH) Factory Size (SQ FT)</strong>", 
                                    df$facility_size_dbh, "<br>",
                                    
                                    "<strong>(DBH) Corporate Family Members</strong>", 
                                    df$corporate_family_dbh, "<br>",
                                    "<strong>(DBH) Company Type:</strong>", 
                                    df$comp_type_dbh, "<br>",
                                    "<strong>(DBH) Parent Company:</strong>", 
                                    df$parent_dbh, "<br>",
                                    "<strong>Address:</strong>", 
                                    df$address, "<br>",
                                    "<strong>Broad Product:</strong>", 
                                    df$broad_product, "<br>",
                                    "<strong>Specific Product:</strong>", 
                                    df$specific_product, "<br>",
                                    "<strong>(DBH) At Site Employees:</strong>", 
                                    df$atsite_emp_dbh, "<br>",
                                    "<strong>(DBH) All Employees:</strong>", 
                                    df$all_site_emp_dbh, "<br>",
                                    "<strong>(DBH) Sales:</strong>",
                                    df$sales_dbh, "<br>",
                                    "<strong>(DBH) Assets:</strong>",
                                    df$assets_dbh, "<br>",
                                    "<strong>Thomasnet Description:</strong>", 
                                    df$tn_desc, "<br>"
                                    ), 
           group = manf_hq)

}
```

We first use this function to set up our individual data layers for mapping. 

```{r}
conf_maps <- prepare_for_maps(conf_all_maps)
```

# Mapping 


```{r}
conf_maps %>% 
  saveRDS(box_here("thomasnet_totals/conf_manfs_geocoded.RDS"))
```

```{r}
conf_maps %>% saveRDS(here("/domestic_manufacturers/conf_maps_geocoded.RDS"))
```


## Differentiating by Supplier Type
```{r}
my_pal <- c(brewer.pal(4, "Set3")[4], brewer.pal(4, "Paired")[2])
```


```{r}
sup1 <- thomas_struc %>% 
  group_by(date, broad_product, specific_product, broad_loc) %>% 
  filter(specific_product != "NA") %>% 
  count() %>% 
  ungroup() %>% 
  mutate(pos = case_when(
    specific_product == "Respirators and Face Masks" ~ 1, 
    specific_product == "Face Masks Only" ~ 2, 
    specific_product == "Respirators Only" ~ 3, 
    specific_product == "Non-Woven Fabric" ~ 5, 
    specific_product == "No Latex Elastic" ~ 6,
    specific_product == "Cloth Masks" ~ 4, 
  ),
  pos_loc = case_when(
    broad_loc == "Manufacturer" ~ 1, 
    broad_loc == "Distributor" ~ 2, 
    broad_loc == "Other/Unknown" ~ 3
  )) %>% 
  filter(broad_loc != "Other/Unknown") %>% 
  mutate(specific_product = reorder(specific_product, pos), 
         broad_loc = reorder(broad_loc, -pos_loc)) %>% 
  ggplot(aes(date, n, fill = broad_loc, group = broad_loc)) +
  geom_area(position = "stack", show.legend = FALSE, color = "Black", alpha = 0.8 ) +
  geom_point(shape =21, color = "Black", alpha = 0.7, size = 1 ,position = "stack") +
  scale_fill_manual(values = my_pal) + 
  facet_wrap(~reorder(specific_product, pos)) +
  labs(title = "Number of Suppliers by Product and Thomasnet Supplier Type", subtitle = "Mask/Respirator Supply Chain: Thomasnet 05/30/20 - 02/22/21", y = "Unique Thomasnet Suppliers", x = "", fill = "Broad Thomasnet Supplier Type") + 
  theme_bw()

sup1
```

# Base Graphs

```{r}
thomas_graph <- thomas_struc %>%  
  filter(specific_product != "NA", broad_loc == "Manufacturer", specific_product != "Cloth Masks") %>% 
  mutate(useful = case_when(
    is.na(useful) ~ "Unknown", 
    TRUE ~ useful
  )) %>% 
  mutate(useful = if_else(medical_market == "Serving Medical Market" & useful != "Affirmatively", "Possibly", useful)) %>% 
  group_by(date, broad_product, specific_product, useful) %>% 
  count()  %>% 
  ungroup() %>% 
  mutate(pos = case_when(
    specific_product == "Respirators and Face Masks" ~ 1, 
    specific_product == "Face Masks Only" ~ 2, 
    specific_product == "Respirators Only" ~ 3, 
    specific_product == "Non-Woven Fabric" ~ 5, 
    specific_product == "No Latex Elastic" ~ 6,
    specific_product == "Cloth Masks" ~ 4, 
  )) %>% 
  mutate(specific_product = fct_reorder(specific_product, -pos)) %>% 
  pivot_wider(c(date, specific_product, pos), names_from = useful, values_from = n, values_fill = 0) %>% 
  mutate(Affirmatively= case_when(
    specific_product == "Respirators and Face Masks" ~ Affirmatively - 1, 
    TRUE ~ as.double(Affirmatively)),
    n_all = Affirmatively + Possibly + Unknown, 
    n_poss_aff = Affirmatively + Possibly)
```

```{r}
slice_date <- mdy("02/22/2021")
```

```{r}
thomas_graph_slice <- thomas_graph %>% 
  filter(date == slice_date)
```

```{r}
med_count <- function(data){
  data %>% 
    filter(specific_product != "NA", broad_loc == "Manufacturer", broad_product == "Intermediary Product") %>% 
    filter(medical_market != "Unknown") %>% 
    mutate(useful = case_when(
      is.na(useful) ~ "Unknown", 
      TRUE ~ useful
    )) %>% 
    group_by(date, broad_product, specific_product, useful) %>% 
    count() %>% 
    ungroup() %>% 
    mutate(pos = case_when(
      specific_product == "Respirators and Face Masks" ~ 1, 
      specific_product == "Face Masks Only" ~ 2, 
      specific_product == "Respirators Only" ~ 3, 
      specific_product == "Non-Woven Fabric" ~ 5, 
      specific_product == "No Latex Elastic" ~ 6,
      specific_product == "Cloth Masks" ~ 4, 
    )) %>% 
    mutate(specific_product = fct_reorder(specific_product, -pos),
           n_aff = case_when(
             useful == "Affirmatively" ~ n
           ),
           n_poss = case_when(
             useful %in% c("Possibly") ~ n
           ))
}
```
```{r}
med_graph <- thomas_struc %>% 
  med_count()

med_graph_slice <- thomas_struc  %>% 
  med_count() %>%  
  filter(date == slice_date)
```


```{r}
test_c <- c(brewer.pal(6, "Set2")[6], brewer.pal(6, "Set2")[5], brewer.pal(6, "Set2")[4], brewer.pal(6, "Set2")[3], brewer.pal(6, "Set2")[2], brewer.pal(6, "Set2")[1])
```
```{r}
test_d <- c(brewer.pal(6, "Set2")[6], brewer.pal(6, "Set2")[5], brewer.pal(6, "Set2")[3], brewer.pal(6, "Set2")[2], brewer.pal(6, "Set2")[1])
```

```{r}
my_pal2 <- c("#E6BB00", "#75a626")
```



```{r}
fig_1 <- thomas_graph_slice %>% 
  ggplot() + 
  scale_fill_manual(values = test_d) + 
  geom_col(aes(specific_product, n_all, fill = specific_product), alpha = 0.3, position = "stack", show.legend = FALSE)  +
  geom_col(data = thomas_graph_slice, aes(specific_product, n_poss_aff, fill = specific_product), alpha = 0.7, color = "dark grey", position = "stack", show.legend = FALSE)  +
    geom_col(data = thomas_graph_slice, aes(specific_product, Affirmatively, fill = specific_product), alpha = 0.9, color = "black", position = "stack", show.legend = FALSE) +
  geom_label(data = thomas_graph_slice, aes(specific_product, Affirmatively, fill = specific_product, label = Affirmatively), size = 5, show.legend = FALSE) +
  new_scale_fill() + 
  geom_col(data = med_graph_slice, aes(specific_product, n_aff, fill = specific_product), show.legend = FALSE) + 
  scale_fill_manual(values = my_pal2) + 
  geom_text(data = med_graph_slice, aes(specific_product, n_aff, label = n_aff), size = 5, hjust = 1 ) + 
  labs(title = "Thomasnet Manufacturers (02/22/21) Self-Identifying as:", x = "", y = "Unique Manufacturing Entities") + 
  coord_flip() +
  theme_bw() + 
  theme(axis.text = element_text(size = 15))

fig_1
```

```{r}
fig_time <- thomas_graph %>% 
  ggplot() +
    geom_area(aes(date, n_all, fill = specific_product), alpha = 0.3, position = "stack", show.legend = FALSE) +
  scale_fill_manual(values = test_c) + 
  geom_point(aes(date, n_all, fill = specific_product), shape = 21, alpha = 0.3, color = "Black", show.legend = FALSE) +
  geom_area(aes(date, n_poss_aff, fill = specific_product), alpha = 0.7, color = "dark grey", position = "stack", show.legend = FALSE)  +
  geom_point(aes(date, n_poss_aff, fill = specific_product), shape = 21, alpha = 0.7, color = "Black", show.legend = FALSE) +
    geom_area(aes(date, Affirmatively, fill = specific_product), alpha = 0.9, color = "black", position = "stack", show.legend = FALSE) +
    geom_point(aes(date, Affirmatively, fill = specific_product), shape = 21, alpha = 0.9, color = "Black", show.legend = FALSE) +
  new_scale_fill() + 
  geom_area(data = med_graph, aes(date, n_aff, fill = specific_product), show.legend = FALSE) +
  geom_point(data = med_graph, aes(date, n_aff, fill = specific_product), shape = 21, color = "Black", show.legend = FALSE) +
  scale_fill_manual(values = my_pal2) + 
  labs(title = "Number of Potential Domestic Manufacturers by Product Type", subtitle = "Source: Thomasnet, 05/30/20 - 11/17/20. Domestic Manufacturers Self-Identifying as: \n1) Producing Standard Products for FDA Approved, Hospital Grade Masks; \n2) Producing Products that Meet Technical Requirements for Hospital Grade Masks; or \n3) Supplying the Medical Market", x = "", y = "") +
  facet_wrap(~reorder(specific_product, pos)) +
  theme_bw()

fig_time
```


## AMMA Graphs 

```{r}
bdm_graph <- bdm_thomas %>% 
  group_by(bdm_product, useful) %>% 
  count() %>% 
  pivot_wider(c(bdm_product), names_from = useful, values_from = n, values_fill = 0) %>% 
  rename(bdm_aff = Affirmatively,
         bdm_unk = Unknown, 
         bdm_new = "NA") %>% 
  rename(specific_product = bdm_product) %>% 
  filter(!is.na(specific_product)) %>% 
  left_join(thomas_graph, .)
```
```{r}
bdm_graph_slice <- bdm_graph %>% 
  filter(date == slice_date) %>% 
  mutate(specific_product = fct_reorder(specific_product, -pos)) %>% 
  mutate(bdm_aff = if_else(is.na(bdm_aff), as.integer(0), bdm_aff),
         bdm_unk = if_else(is.na(bdm_unk), as.integer(0), bdm_unk),
         bdm_new = if_else(is.na(bdm_new), as.integer(0), bdm_new))
```

```{r}
color_5 <- c(brewer.pal(6, "Set2")[6], brewer.pal(6, "Set2")[5], brewer.pal(6, "Set2")[3], brewer.pal(6, "Set2")[2], brewer.pal(6, "Set2")[1])
```

```{r}
bdm_1 <- bdm_graph_slice %>% 
  ggplot() + 
  geom_col(aes(specific_product, n_all + bdm_new, fill = specific_product), alpha = 0.3, position = "stack", show.legend = FALSE)  +
  geom_col(aes(specific_product, n_poss_aff + bdm_new + bdm_unk, fill = specific_product), alpha = 0.5, color = "Black", position = "stack", show.legend = FALSE)  +
  geom_col(aes(specific_product, n_poss_aff + bdm_new, fill = specific_product), alpha = 0.7, color = "dark grey", position = "stack", show.legend = FALSE)  +
    geom_col(aes(specific_product, Affirmatively + bdm_new, fill = specific_product), alpha = 0.9, color = "black", position = "stack", show.legend = FALSE) +
  geom_col(aes(specific_product, Affirmatively + bdm_new, fill = specific_product), alpha = 0.9, color = "black", position = "stack", show.legend = FALSE) +
    geom_col(aes(specific_product, bdm_aff + bdm_new, fill = specific_product), alpha = 0.3, fill = "Black",  color = "black", position = "stack", show.legend = FALSE) +
  geom_label(aes(specific_product, Affirmatively + bdm_new, fill = specific_product, label = "     "), size = 5, show.legend = FALSE, hjust = 0.01) +
  scale_fill_manual(values = color_5) + 
  new_scale_fill() + 
  geom_col(data = med_graph_slice, aes(specific_product, n_aff + 1, fill = specific_product), show.legend = FALSE) + 
  scale_fill_manual(values = my_pal2) + 
  geom_col(aes(specific_product, bdm_new), alpha = 0.9, fill = "White",  color = "black", position = "stack", show.legend = FALSE) +
  labs(title = "USBDM and Thomasnet Manufacturers (02/22/21) Self-Identifying as:", x = "", y = "Unique Manufacturing Entities") + 
  coord_flip() +
  theme_bw() + 
  theme(axis.text = element_text(size = 15))


```
## Zooming in


```{r}
dom_colors <- c(brewer.pal(6, "Set2")[1], brewer.pal(6, "Set2")[2], brewer.pal(6, "Set2")[3], brewer.pal(6, "Set2")[5], brewer.pal(6, "Set2")[6])
```


```{r}
aff_dom <- all_dom %>% 
  filter(!is.na(dom_useful)) %>% 
  mutate(dom_useful = case_when(
    dom_useful == "0" ~ "No", 
    dom_useful == "Possibly" ~ "Unknown", 
    dom_useful == "1" ~ "Yes"
  )) %>% 
  group_by(date, specific_product, dom_useful) %>% 
  count() %>% 
  ungroup() %>% 
  mutate(pos = case_when(
    specific_product == "Respirators and Face Masks" ~ 1, 
    specific_product == "Face Masks Only" ~ 2, 
    specific_product == "Respirators Only" ~ 3, 
    specific_product == "Non-Woven Fabric" ~ 5, 
    specific_product == "No Latex Elastic" ~ 6,
    specific_product == "Cloth Masks" ~ 4, 
  )) %>% 
  mutate(specific_product = fct_reorder(specific_product, -pos)) %>% 
  pivot_wider(c(date, specific_product, pos), names_from = dom_useful, values_from = n, values_fill = 0)
    #%>% 
  #mutate(n = case_when(
           #pos == 2 & date == ymd("2020-09-08") ~ 9,
           #pos == 2 & date != ymd("2020-09-08") ~ as.double(n), 
         #pos != 2 ~ as.double(n)))
```

```{r}
aff_dom_slice <- aff_dom %>% 
  filter(date == slice_date) #%>% 
  #mutate(n = case_when(
    #specific_product == "Face Masks Only" ~ 14,
    #specific_product == "Respirators Only" ~ 2,
    #TRUE ~ as.double(n)
  #))
```

```{r}
fig_2 <- aff_dom_slice %>% 
  ggplot() + 
  geom_col(aes(specific_product, No + Unknown + Yes ), fill = "Black", position = "stack", show.legend = FALSE, color = "Black")  +
  geom_col(aes(specific_product, Unknown + Yes), fill = "Light Grey", position = "stack", show.legend = FALSE, color = "Black")  +
  geom_col(aes(specific_product, Yes), fill = "Light Blue", position = "stack", show.legend = FALSE, color = "Black")  +
  geom_label(aes(specific_product, Yes + No + Unknown , fill = specific_product, label = "     ", hjust = 0.01), size = 5, show.legend = FALSE) +
  scale_fill_manual(values = color_5) + 
  labs(title = "Thomasnet Manufacturers Self Identifying As: \nProducing Standard Products for FDA Approved, Hospital Grade Masks/Respirators (02/22/21)", x = "", y = "Unique Manufacturing Entities") + 
  coord_flip() +
  theme_bw() + 
  theme(axis.text = element_text(size = 15))
```

```{r}
bdm_graph_2 <- bdm_thomas %>% 
  group_by(bdm_product, useful) %>% 
  count() %>% 
  pivot_wider(c(bdm_product), names_from = useful, values_from = n, values_fill = 0) %>% 
  rename(bdm_aff = Affirmatively,
         bdm_unk = Unknown, 
         bdm_new = "NA") %>% 
  rename(specific_product = bdm_product) %>% 
  filter(!is.na(specific_product)) %>% 
  left_join(aff_dom, .)
```
```{r}
bdm_graph_slice_2 <- bdm_graph_2 %>% 
  filter(date == slice_date) %>% 
  mutate(specific_product = fct_reorder(specific_product, -pos)) %>% 
  mutate(bdm_aff = if_else(is.na(bdm_aff), as.integer(0), bdm_aff),
         bdm_unk = if_else(is.na(bdm_unk), as.integer(0), bdm_unk),
         bdm_new = if_else(is.na(bdm_new), as.integer(0), bdm_new))
```

```{r}
color_5 <- c(brewer.pal(6, "Set2")[6], brewer.pal(6, "Set2")[5], brewer.pal(6, "Set2")[3], brewer.pal(6, "Set2")[2], brewer.pal(6, "Set2")[1])
```

```{r}
bdm_2 <- bdm_graph_slice_2 %>% 
  ggplot() + 
  geom_col(aes(specific_product, No + Unknown + Yes + bdm_new + bdm_unk), fill = "Navy Blue", alpha = 0.5, position = "stack", show.legend = FALSE, color = "Black")  +
  geom_col(aes(specific_product, No + Unknown + Yes + bdm_new + bdm_unk), fill = "Black", position = "stack", show.legend = FALSE, color = "Black")  +
  geom_col(aes(specific_product, Unknown + Yes + bdm_new), fill = "Light Grey", position = "stack", show.legend = FALSE, color = "Black")  +
    geom_col(aes(specific_product, Yes + bdm_new), fill = "Light Blue", position = "stack", show.legend = FALSE, color = "Black")  +
    geom_col(aes(specific_product, bdm_aff +  bdm_new), alpha = 0.3, fill = "Black", position = "stack", show.legend = FALSE, color = "Black")  +
  geom_col(aes(specific_product, bdm_new), alpha = 0.9, fill = "White", position = "stack", show.legend = FALSE, color = "Black")  +
  geom_label(aes(specific_product, bdm_new + Yes + No + Unknown + bdm_unk, fill = specific_product, label = "     ", hjust = 0.01), size = 5, show.legend = FALSE) +
  scale_fill_manual(values = color_5) + 
  labs(title = "USBDM and Thomasnet Manufacturers Self Identifying As: \nProducing Standard Products for FDA Approved, Hospital Grade Masks/Respirators (02/22/21)", x = "", y = "Unique Manufacturing Entities") + 
  coord_flip() +
  theme_bw() + 
  theme(axis.text = element_text(size = 15))


```

###3 
```{r}
neg_dom <- all_dom %>% 
  group_by(date, broad_product, specific_product) %>% 
  count() %>% 
  ungroup() %>% 
  mutate(pos = case_when(
    specific_product == "Respirators and Face Masks" ~ 1, 
    specific_product == "Face Masks Only" ~ 2, 
    specific_product == "Respirators Only" ~ 3, 
    specific_product == "Non-Woven Fabric" ~ 5, 
    specific_product == "No Latex Elastic" ~ 6,
    specific_product == "Cloth Masks" ~ 4, 
  )) %>% 
  mutate(specific_product = fct_reorder(specific_product, -pos))
```

```{r}
neg_dom_slice <- neg_dom %>% 
  filter(date == slice_date)
```

```{r}
poss_dom <- all_dom %>% 
  filter(dom_useful == "Possibly" | dom_useful == "1") %>% 
  group_by(date, broad_product, specific_product) %>% 
  count() %>% 
  ungroup() %>% 
  mutate(pos = case_when(
    specific_product == "Respirators and Face Masks" ~ 1, 
    specific_product == "Face Masks Only" ~ 2, 
    specific_product == "Respirators Only" ~ 3, 
    specific_product == "Non-Woven Fabric" ~ 5, 
    specific_product == "No Latex Elastic" ~ 6,
    specific_product == "Cloth Masks" ~ 4, 
  )) %>% 
  mutate(specific_product = fct_reorder(specific_product, -pos))
```

```{r}
poss_dom_slice <- poss_dom %>% 
  filter(date == slice_date)  
```

```{r}
base_graph <- thomas_struc %>% 
    filter(broad_loc == "Manufacturer") %>% 
    filter(specific_product != "Cloth Masks", date == mdy("07/13/20")) %>% 
    group_by(broad_product, specific_product) %>% 
    filter(specific_product != "NA") %>% 
    count() %>% 
    mutate(pos = case_when(
    specific_product == "Respirators and Face Masks" ~ 1, 
    specific_product == "Face Masks Only" ~ 2, 
    specific_product == "Respirators Only" ~ 3, 
    specific_product == "Non-Woven Fabric" ~ 5, 
    specific_product == "No Latex Elastic" ~ 6,
    specific_product == "Cloth Masks" ~ 4, 
  )) %>% 
    ungroup() %>% 
    mutate(specific_product = reorder(specific_product, -pos) ) %>% 
  ggplot(aes(specific_product, n, fill = specific_product, label = n)) +
    scale_fill_manual(values = dom_colors) +
    theme_bw()
```


```{r}
label_data <- aff_dom_slice %>% 
  rename(aff_n = n) %>% 
  left_join(poss_dom_slice) %>% 
  rename(poss_aff_n = n) %>% 
  left_join(neg_dom_slice) %>% 
  mutate(neg_n = n - poss_aff_n)
```

```{r}
fig_2 <- base_graph + 
  coord_flip() +
  geom_col(data = neg_dom_slice, aes(specific_product, n, fill = reorder(specific_product, pos)), show.legend = FALSE, position = "stack", color = "Black") +
  geom_col(data = neg_dom_slice, aes(specific_product, n), position = "stack", show.legend = FALSE, fill = "Black", color = "Black") +
  geom_col(data = poss_dom_slice, aes(specific_product, n), position = "stack", show.legend = FALSE, fill = "Light Grey", color = "Black") +
  geom_label(data = label_data, aes(specific_product, poss_aff_n, label = neg_n), fill = "Black", color = "Light Grey", size = 5, position = "stack", hjust = 1) + 
  geom_col(data = aff_dom_slice, aes(reorder(specific_product, pos)), fill = "Light Blue", color = "Black") +
  geom_label(data = thomas_graph_slice, aes(specific_product, Affirmatively, fill = specific_product, label = Affirmatively), size = 5, show.legend = FALSE)  +
  geom_label(data = aff_dom_slice, aes(label = n), fill = "Light Blue", size = 5, color = "Black", show.legend = FALSE, y = 0, nudge_y = -2) + 
  labs(x = "", y = "Unique Manufacturing Entities", title = "Thomasnet Manufacturers Self-Identifying as: \nProducing Standard Products for FDA Approved, Hospital Grade Masks/Respirators (02/22/21)", fill = "Specific Product") + 
  theme(axis.text = element_text(size = 15))
```


```{r}
base2 <- all_dom %>% 
  group_by(date, broad_product, specific_product) %>% 
  count() %>% 
  ungroup() %>% 
  mutate(pos = case_when(
    specific_product == "Respirators and Face Masks" ~ 1, 
    specific_product == "Face Masks Only" ~ 2, 
    specific_product == "Respirators Only" ~ 3, 
    specific_product == "Non-Woven Fabric" ~ 5, 
    specific_product == "No Latex Elastic" ~ 6,
    specific_product == "Cloth Masks" ~ 4, 
  )) %>% 
  mutate(specific_product = fct_reorder(specific_product, pos)) %>%
  filter(specific_product == "Respirators and Face Masks") %>% 
  ggplot(aes(date, n, fill = specific_product, group = specific_product)) +
  scale_fill_manual(values = dom_colors) + 
  facet_wrap(~reorder(specific_product, pos)) +
  theme_bw()
```

```{r}
time_conf <- base2 + 
  geom_area(data = neg_dom, aes(date, n, group = specific_product), position = "stack", fill = "Black", color = "White") +
  geom_area(data = poss_dom, aes(date, n, group = specific_product), position = "stack", fill = "Light Grey", color = "White") + 
  geom_area(data = aff_dom, aes(date, Yes, group = specific_product), position = "stack", fill = "Light Blue", color = "White") + 
  
  geom_line(data = neg_dom, aes(date, n, group = specific_product, color = specific_product), size = 1.3, position = "stack", show.legend = FALSE) +
  scale_color_manual(values = test_d) + 
  geom_point(data = aff_dom, aes(date, Yes, group = specific_product), position = "stack", shape = 21, size = 2, fill = "Light Blue", color = "Black", alpha = 0.75) +

  labs(title = "Thomasnet Manufacturers Self-Identifying as: \nProducing Standard Products for FDA Approved, Hospital Grade Masks/Respirators (05/30/20 - 02/22/21)", y = "Unique Manufacturing Entities", x = "") + 
  theme(strip.text = element_text(size = 12))
```




```{r}
base2 <- all_dom %>% 
  group_by(date, broad_product, specific_product) %>% 
  count() %>% 
  ungroup() %>% 
  mutate(pos = case_when(
    specific_product == "Respirators and Face Masks" ~ 1, 
    specific_product == "Face Masks Only" ~ 2, 
    specific_product == "Respirators Only" ~ 3, 
    specific_product == "Non-Woven Fabric" ~ 5, 
    specific_product == "No Latex Elastic" ~ 6,
    specific_product == "Cloth Masks" ~ 4, 
  )) %>% 
  mutate(specific_product = fct_reorder(specific_product, pos)) %>%
  filter(specific_product == "Respirators and Face Masks") %>% 
  ggplot(aes(date, n, fill = specific_product, group = specific_product)) +
  scale_fill_manual(values = dom_colors) + 
  facet_wrap(~reorder(specific_product, pos)) +
  theme_bw()
```

```{r}
time_conf <- base2 + 
  geom_area(data = neg_dom, aes(date, n, group = specific_product), position = "stack", fill = "Black", color = "White") +
  geom_area(data = poss_dom, aes(date, n, group = specific_product), position = "stack", fill = "Light Grey", color = "White") + 
  geom_area(data = aff_dom, aes(date, Yes, group = specific_product), position = "stack", fill = "Light Blue", color = "White") + 
  
  geom_line(data = neg_dom, aes(date, n, group = specific_product, color = specific_product), size = 1.3, position = "stack", show.legend = FALSE) +
  scale_color_manual(values = test_d) + 
  geom_point(data = aff_dom, aes(date, Yes, group = specific_product), position = "stack", shape = 21, size = 2, fill = "Light Blue", color = "Black", alpha = 0.75) +

  labs(title = "Thomasnet Manufacturers Self-Identifying as: \nProducing Standard Products for FDA Approved, Hospital Grade Masks/Respirators (05/30/20 - 02/22/21)", y = "Unique Manufacturing Entities", x = "") + 
  theme(strip.text = element_text(size = 12))
```

```{r}
all_dom %>% filter(broad_product == "End Product") %>%
  group_by(company, dom_useful) %>%
  mutate(tal = seq(n())) %>% 
  filter(tal == 1) %>% 
  group_by(dom_useful) %>% 
  count()
```

