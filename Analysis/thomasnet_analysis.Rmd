---
title: "thomasnet_analysis"
author: "Nikhil Kalathil"
date: "6/17/2020"
output:
  html_document:
    df_print: paged
    toc: true
    toc_float: true
    theme: flatly
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r, include == FALSE }
library(tidyverse)
library(tidytext)
library(RColorBrewer)
library(ggthemes)
library(tm)
library(here)
library(ggrepel)
library(lubridate)
```

```{r}
thomas_an <- readRDS(here("Data/Cleaned/fm_resp.RDS")) %>% 
  filter(date == mdy("05/30/2020"))
int_prod <- readRDS(here("Data/Cleaned/int_prod.RDS")) %>% 
  filter(date == mdy("05/30/2020"))
```

This document analyzes cleaned thomasnet data. Thomasnet data provides a picture of the US supply chain for specific categories. In this document, we focus on analyzing the face mask/respirator supply chain. 

```{r}
my_pal <- c("cadetblue", "darkblue", "green", "darkgreen", "darkgrey")
```

# Summary plots

We begin with summary plots of our data. 

```{r}
thomas_struc <- bind_rows(int_prod, thomas_an)
```


## All Companies

The first figures display counts for all products in our dataset. 

```{r}
fig1 <- thomas_struc %>% 
  group_by(broad_product, specific_product) %>% 
  filter(specific_product != "NA") %>% 
  count() %>% 
  mutate(pos = case_when(
    specific_product == "Respirators and Face Masks" ~ 1, 
    specific_product == "Face Masks Only" ~ 2, 
    specific_product == "Respirators Only" ~ 3, 
    specific_product == "Non-Woven Fabric" ~ 5, 
    specific_product == "No Latex Elastic" ~ 6,
    specific_product == "Cloth Masks" ~ 4, 
  )) %>% 
  ungroup() %>% 
  mutate(specific_product = reorder(specific_product, pos) ) %>% 
  ggplot(aes(reorder(specific_product, -pos), n, fill = specific_product, label = n)) +
  scale_fill_brewer(palette = "Set2") +
  theme_bw() + 
  coord_flip() + 
  labs(title = "Number of Suppliers by Product Type", subtitle = "Thomasnet 5/29/20", y = "", x = "", fill = "Specific Product")

fig1lab <- fig1 + 
  geom_col(position = "dodge", show.legend = FALSE) +
  geom_label(show.legend = FALSE) 

fig1lab
```

## Segmenting by FDA Requirements

```{r}
poss_graph <- thomas_struc %>% 
  filter(specific_product != "NA") %>% 
  mutate(useful = case_when(
    is.na(useful) ~ "Unknown", 
    useful == "Affirmatively" ~ "Possibly",
    TRUE ~ useful
  )) %>% 
  group_by(broad_product, specific_product, useful) %>% 
  count() %>% 
  ungroup() %>% 
  mutate(pos = case_when(
    specific_product == "Respirators and Face Masks" ~ 1, 
    specific_product == "Face Masks Only" ~ 2, 
    specific_product == "Respirators Only" ~ 3, 
    specific_product == "Non-Woven Fabric" ~ 5, 
    specific_product == "No Latex Elastic" ~ 6,
    specific_product == "Cloth Masks" ~ 4, 
  )) %>% 
  mutate(specific_product = fct_reorder(specific_product, -pos),
         n_aff = case_when(
           useful == "Affirmatively" ~ n
  ),
           n_poss = case_when(
           useful %in% c("Possibly") ~ n
  ))
```


```{r}
fig2 <- fig1 +
  geom_col(position = "dodge", show.legend = FALSE, alpha = 0.7) +
  geom_col(data = poss_graph, aes(specific_product, n_poss, fill = specific_product), color = "Black", position = "stack", show.legend = FALSE) +
  geom_label(data = poss_graph, aes(label = n_poss), show.legend = FALSE) +
  labs(subtitle = "Thomasnet 5/29/20. \nSelf-Identifying as Serving Medical Markets or Affirmatively Meeting FDA Specs")

fig2
```

```{r}
aff_graph <- thomas_struc %>% 
  filter(specific_product != "NA") %>% 
  mutate(useful = case_when(
    is.na(useful) ~ "Unknown",
    TRUE ~ useful
  )) %>% 
  group_by(broad_product, specific_product, useful) %>% 
  count() %>% 
  ungroup() %>% 
  mutate(pos = case_when(
    specific_product == "Respirators and Face Masks" ~ 1, 
    specific_product == "Face Masks Only" ~ 2, 
    specific_product == "Respirators Only" ~ 3, 
    specific_product == "Non-Woven Fabric" ~ 5, 
    specific_product == "No Latex Elastic" ~ 6,
    specific_product == "Cloth Masks" ~ 4, 
  )) %>% 
  mutate(specific_product = fct_reorder(specific_product, -pos),
         n_aff = case_when(
           useful == "Affirmatively" ~ n
  ))
```


```{r}
fig3 <- fig1 +
  geom_col(position = "dodge", show.legend = FALSE, alpha = 0.3, color = "light grey") +
  geom_col(data = poss_graph, aes(specific_product, n_poss, fill = specific_product), color = "dark grey", position = "stack", show.legend = FALSE, alpha = 0.75) +
    geom_col(data = aff_graph, aes(specific_product, n_aff, fill = specific_product), color = "black", position = "stack", show.legend = FALSE) +
  geom_label(data = aff_graph, aes(label = n_aff), show.legend = FALSE) +
  labs(subtitle = "Thomasnet 5/29/20. \nSelf-Identifying as Affirmatively Meeting FDA Specs")

fig3
```


```{r}
thomas_struc %>% 
  filter(!is.na(useful)) %>% 
  mutate(useful = case_when(
    useful == "Affirmatively" ~ "Affirmatively Meets FDA Specs", 
    useful == "Possibly" ~ "Possibly Meets FDA Specs"
  )) %>% 
  group_by(broad_product, specific_product, useful) %>% 
  filter(specific_product != "NA") %>% 
  count() %>%   
  mutate(pos = case_when(
    specific_product == "Respirators and Face Masks" ~ 1, 
    specific_product == "Face Masks Only" ~ 2, 
    specific_product == "Respirators Only" ~ 3, 
    specific_product == "Non-Woven Fabric" ~ 5, 
    specific_product == "No Latex Elastic" ~ 6,
    specific_product == "Cloth Masks" ~ 4, 
  ))  %>% 
  ggplot(aes(reorder(specific_product, -pos), n, fill = specific_product, label = n)) +
  geom_col(position = "dodge", show.legend = FALSE) + 
  geom_label(show.legend = FALSE) +
  scale_fill_brewer(palette = "Set2") +
  theme_bw() + 
  coord_flip() + 
  facet_wrap(~useful) +
  labs(title = "Number of Suppliers by Product Type", subtitle = "Thomasnet 5/29/20", y = "", x = "", fill = "Specific Product") 

```

## Differentiating by supplier types

We then turn to differentiating by supplier types to look at the proportion of companies that are distributors compared to manufacturers. 

```{r}
my_pal <- c(brewer.pal(4, "Set3")[4], brewer.pal(4, "Set3")[1], "grey")
```

```{r}
sup1 <- thomas_struc %>% 
  filter(useful %in% c("Affirmatively"), specific_product != "Cloth Masks") %>% 
  mutate(broad_loc = case_when(
    str_detect(broad_loc, "Manuf") ~ "Manufacturer", 
    str_detect(broad_loc, "Dist") ~ "Distributor",
    TRUE ~ "Other/Unknown"
  )) %>% 
  group_by(broad_product, specific_product, broad_loc) %>% 
  filter(specific_product != "NA") %>% 
  count() %>% 
  ungroup() %>% 
  mutate(pos = case_when(
    specific_product == "Respirators and Face Masks" ~ 1, 
    specific_product == "Face Masks Only" ~ 2, 
    specific_product == "Respirators Only" ~ 3, 
    specific_product == "Non-Woven Fabric" ~ 4, 
    specific_product == "No Latex Elastic" ~ 5
  )) %>% 
  ggplot(aes(reorder(specific_product, -pos), n, fill = broad_loc, group = broad_loc)) +
  geom_col(position = "dodge") + 
  geom_label(position=position_dodge(width=1), aes(label = n), show.legend = FALSE) +
  scale_fill_manual(values = my_pal) +
  geom_vline(xintercept = 2.5) +
  theme_bw() + 
  coord_flip() + 
  ggplot2:: annotate("label", x = 2.8, y = 85, label = "End Products") + 
    ggplot2:: annotate("label", x = 1.8, y = 85, label = "Intermediary Products") + 
  labs(title = "Number of Suppliers by Product and Supplier Type", subtitle = "Self-Identifying as Meeting FDA Specs, Thomasnet 5/29/20", y = "", x = "", fill = "Supplier Type") 
```

```{r}
sup_base <- thomas_struc %>% 
  filter(useful %in% c("Affirmatively"), specific_product != "Cloth Masks") %>% 
  mutate(broad_loc = case_when(
    str_detect(broad_loc, "Manuf") ~ "Manufacturer", 
    str_detect(broad_loc, "Dist") ~ "Distributor",
    TRUE ~ "Other/Unknown"
  )) %>% 
  group_by(broad_product, specific_product, broad_loc) %>% 
  filter(specific_product != "NA") %>% 
  count() %>% 
  ungroup() %>% 
  mutate(pos = case_when(
    specific_product == "Respirators and Face Masks" ~ 1, 
    specific_product == "Face Masks Only" ~ 2, 
    specific_product == "Respirators Only" ~ 3, 
    specific_product == "Non-Woven Fabric" ~ 4, 
    specific_product == "No Latex Elastic" ~ 5
  )) %>% 
  rename(ref = n) %>% 
  filter(broad_loc == "Manufacturer")
```


```{r}
sup2 <- thomas_struc %>% 
  filter(useful %in% c("Affirmatively", "Possibly"), specific_product != "Cloth Masks") %>% 
  mutate(broad_loc = case_when(
    str_detect(broad_loc, "Manuf") ~ "Manufacturer", 
    str_detect(broad_loc, "Dist") ~ "Distributor",
    TRUE ~ "Other/Unknown"
  )) %>% 
  group_by(broad_product, specific_product, broad_loc) %>% 
  filter(specific_product != "NA") %>% 
  count() %>% 
  ungroup() %>% 
  mutate(pos = case_when(
    specific_product == "Respirators and Face Masks" ~ 1, 
    specific_product == "Face Masks Only" ~ 2, 
    specific_product == "Respirators Only" ~ 3, 
    specific_product == "Non-Woven Fabric" ~ 4, 
    specific_product == "No Latex Elastic" ~ 5
  )) %>% 
  left_join(sup_base) %>% 
  mutate(pct_change = (n-ref)/ref,
         change_lab = case_when(
           broad_loc == "Manufacturer" & specific_product != "Respirators Only" ~ paste("+ ",100*round(pct_change,2)," %", sep = ""))) %>% 
  ggplot(aes(reorder(specific_product, -pos), n, fill = broad_loc, group = broad_loc)) +
  geom_col(position = "dodge") + 
  geom_label(position=position_dodge(width=1), aes(label = n), show.legend = FALSE) +
  scale_fill_manual(values = my_pal) +
  geom_vline(xintercept = 2.5) +
  theme_bw() + 
  coord_flip() + 
  geom_label(position=position_dodge(width=1), aes(label = change_lab), fill = brewer.pal(3, "Set3")[1], hjust = 3, vjust = 1) +
  ggplot2:: annotate("label", x = 2.8, y = 85, label = "End Products") + 
    ggplot2:: annotate("label", x = 1, y = 85, label = "Intermediary Products") + 
  labs(title = "Number of Suppliers by Product and Supplier Type", subtitle = "Self-Identifying as Serving Medical Market or Meeting FDA Specs. \nThomasnet 5/29/20. \n% Change Relative to Self-Identifying as Meeting FDA Specs Alone", y = "", x = "", fill = "Supplier Type") 
```


### Proportions

```{r}
prop_end <- thomas_struc %>%
  filter(useful %in% c("Affirmatively")) %>% 
  filter(!is.na(specific_product)) %>% 
  mutate(broad_loc = case_when(
    str_detect(broad_loc, "Manuf") ~ "Manufacturer", 
    str_detect(broad_loc, "Dist") ~ "Distributor",
    TRUE ~ "Other/Unknown"
  )) %>% 
  group_by(broad_loc, specific_product) %>% 
  count() %>% 
  ungroup() %>% 
  group_by(specific_product) %>% 
  mutate(prop = n / sum (n)) %>%
  filter(specific_product %in% c("Respirators and Face Masks", "Face Masks Only", "Respirators Only")) %>% 
  mutate(lab_prop = round(case_when(
    broad_loc == "Manufacturer" ~ prop
  ),2)) %>% 
  ggplot(aes(specific_product, prop, fill = broad_loc, label = lab_prop)) +
  geom_col(position = "stack", show.legend = FALSE) + 
  geom_label(show.legend = FALSE) + 
  scale_fill_manual(values = my_pal) +
  coord_flip() +
  theme_bw() + 
  labs(title = "Prop of US Suppliers of End Products, \nby Supplier Type", subtitle = "Self-Identifying as Meeting FDA Specs, Thomasnet 5/29/2020", fill = "Supplier Type", x = "", y = "Proportion")
```

We are interested in performing a similar analysis on intermediary products. 

```{r}
prop_int <- thomas_struc %>%
  filter(useful %in% c("Affirmatively")) %>% 
  filter(!is.na(specific_product)) %>%
  mutate(broad_loc = case_when(
    str_detect(broad_loc, "Manuf") ~ "Manufacturer", 
    str_detect(broad_loc, "Dist") ~ "Distributor",
    TRUE ~ "Other/Unknown"
  )) %>% 
  group_by(broad_loc, specific_product) %>% 
  count() %>% 
  ungroup() %>% 
  group_by(specific_product) %>% 
  mutate(prop = n / sum (n)) %>%
  filter(!specific_product %in% c("Respirators and Face Masks", "Face Masks Only", "Respirators Only", "Cloth Masks")) %>% 
  mutate(lab_prop = round(case_when(
    broad_loc == "Manufacturer" ~ prop
  ),2)) %>% 
  ggplot(aes(specific_product, prop, fill = broad_loc, label = lab_prop)) +
  geom_col(position = "stack") + 
  geom_label(show.legend = FALSE) + 
  scale_fill_manual(values = my_pal) +
  coord_flip() +
  theme_bw() + 
  labs(title = "Prop of US Suppliers of Intermediary Products, \nby Supplier Type", subtitle = "Self-Identifying as Meeting FDA Specs, Thomasnet 5/29/2020", fill = "Supplier Type", x = "", y = "Proportion")
```

```{r}
thomas_struc %>%
  filter(useful %in% c("Affirmatively", "Possibly")) %>% 
  filter(!is.na(specific_product)) %>% 
  mutate(broad_loc = case_when(
    str_detect(broad_loc, "Manuf") ~ "Manufacturer", 
    str_detect(broad_loc, "Dist") ~ "Distributor",
    TRUE ~ "Other/Unknown"
  )) %>% 
  group_by(broad_loc, specific_product) %>% 
  count() %>% 
  ungroup() %>% 
  group_by(specific_product) %>% 
  mutate(prop = n / sum (n)) %>%
  filter(specific_product %in% c("Respirators and Face Masks", "Face Masks Only", "Respirators Only")) %>% 
  mutate(lab_prop = round(case_when(
    broad_loc == "Manufacturer" ~ prop
  ),2)) %>% 
  ggplot(aes(specific_product, prop, fill = broad_loc, label = lab_prop)) +
  geom_col(position = "stack") + 
  geom_label(show.legend = FALSE) + 
  scale_fill_manual(values = my_pal) +
  coord_flip() +
  theme_bw() + 
  labs(title = "Prop of US Suppliers of End Products, \nby Supplier Type", subtitle = "Affirmatively meets FDA Specs, Thomasnet 5/29/2020", fill = "Supplier Type", x = "", y = "Proportion")
```

## Number of distributors over time

```{r}
my_pal <- c(brewer.pal(4, "Set3")[4], brewer.pal(4, "Set3")[1], "grey")
```

```{r}
thomas_all <- readRDS(here("Data/Cleaned/thomas_allprods.RDS"))
```

```{r}
thomas_time <- thomas_all %>%
  filter(!is.na(specific_product)) %>%
  mutate(broad_loc = case_when(
    str_detect(broad_loc, "Manuf") ~ "Manufacturer", 
    str_detect(broad_loc, "Dist") ~ "Distributor",
    TRUE ~ "Other/Unknown"
  )) %>% 
  group_by(broad_loc, specific_product, date) %>% 
  count() %>% 
  ungroup() %>% 
  group_by(specific_product) %>% 
  mutate(prop = n / sum (n))
```

```{r}
fig3 <- thomas_time %>% 
  ggplot(aes(date, n, group = broad_loc, color = broad_loc, fill = broad_loc)) +
  geom_line(show.legend = FALSE) + 
  geom_point(shape = 21, alpha = 0.7, size = 3, color = "Black") + 
  scale_fill_manual(values = my_pal) + 
  scale_color_manual(values = my_pal) + 
  facet_wrap(~specific_product) + 
  labs(title = "Thomasnet Suppliers Self-Identifying as Producing a Specific Product, 05/30/20 - 06/30/20", subtitle = "By Supplier Type, All Product Specs", x = "", y = "Suppliers", fill = "") + 
  theme_bw()
```


```{r}
thomas_time_fda <- thomas_all %>%
  filter(useful %in% c("Affirmatively")) %>% 
  filter(!is.na(specific_product)) %>%
  mutate(broad_loc = case_when(
    str_detect(broad_loc, "Manuf") ~ "Manufacturer", 
    str_detect(broad_loc, "Dist") ~ "Distributor",
    TRUE ~ "Other/Unknown"
  )) %>% 
  group_by(broad_loc, specific_product, date) %>% 
  count() %>% 
  ungroup() %>% 
  group_by(specific_product) %>% 
  mutate(prop = n / sum (n))

fig4 <- thomas_time_fda %>%
  filter(specific_product %in% c("Face Masks Only", "Respirators and Face Masks", "Respirators Only")) %>% 
  ggplot(aes(date, n, group = broad_loc, color = broad_loc, fill = broad_loc)) +
  geom_line(show.legend = FALSE) + 
  geom_point(shape = 21, alpha = 0.7, size = 3, color = "Black") + 
  scale_fill_manual(values = my_pal) + 
  scale_color_manual(values = my_pal) + 
  facet_wrap(~specific_product) + 
  labs(title = "Thomasnet Suppliers Over Time", subtitle = "By Supplier Type, Products that Affirmatively or Possibly Meet FDA Specs", x = "", y = "Suppliers", fill = "") + 
  theme_bw()
```

# Identifying Companies that have pivoted

To identify companies that have pivoted, we begin by defining a list of words that identify if a company has pivoted or not. 

```{r}
pivot_list <- c("pivot", "shift", "new", "scale", "ramp", "increase", "now")
```

```{r}
paste(unlist(pivot_list), sep = "")
```


```{r}
thomas_pivot <- thomas_all %>% 
  mutate(desc_low = tolower(desc)) %>% 
  mutate(pivot_poss = case_when(
           str_detect(desc_low, " pivot") | 
            str_detect(desc_low, " shift") | 
            str_detect(desc_low, " new ") | 
            str_detect(desc_low, " scaled") | 
            str_detect(desc_low, " scale up") |
            str_detect(desc_low, " ramp") | 
            str_detect(desc_low, " increase") |
            str_detect(desc_low, " now")  ~ 1))
```

```{r}
thomas_pivot %>% 
  filter(!is.na(pivot_poss)) %>% 
  select(company, date, desc, pivot_poss) %>% 
  view()
```

```{r}
mypal2 <- c(brewer.pal(6, "Set2")[1], brewer.pal(6, "Set2")[2], brewer.pal(6, "Set2")[4], brewer.pal(6, "Set2")[3], brewer.pal(6, "Set2")[5], "grey")
```


```{r}
thomas_pivot %>% 
  filter(!is.na(pivot_poss), !is.na(specific_product)) %>%
  group_by(date, specific_product) %>% 
  count() %>% 
  ungroup() %>% 
  mutate(specific_product = reorder(specific_product, -n)) %>% 
  ggplot(aes(date, n, fill = specific_product)) + 
  geom_point(shape = 21, alpha = 0.7, color = "black", size = 4) + 
  geom_line(aes(color = specific_product), show.legend = FALSE) + 
  scale_fill_manual(values = mypal2) +
  scale_color_manual(values = mypal2) +
  labs(title = "Suppliers With Pivot or Scale Relevant \nWords in Thomasnet Descriptions", subtitle = "Words: 'pivot', 'shift', 'new', 'scaled', 'scale up', 'ramp', 'increase', 'now'", y = "Unique Suppliers", fill = "Specific Product", x = "") + 
  theme_bw() 
```



# JUNK WORK 

## Checking Validity of Product Modeling Possibilities 

```{r}
thomas_struc %>% 
  filter(str_detect(desc, fixed("Capabilities include", ignore_case = TRUE)) |
           str_detect(desc, fixed("Our masks are", ignore_case = TRUE)) |
           str_detect(desc, fixed("We offer", ignore_case = TRUE)) |
           str_detect(desc, fixed("sq ft", ignore_case = TRUE)) | 
           str_detect(desc, fixed("services include", ignore_case = TRUE)) |
           str_detect(desc, fixed("services offered", ignore_case = TRUE)) 
         ) %>% 
  count()
```


## Using Tidytext to Model Differences Between Supplier Types  

```{r}
thomas_text <- thomas_struc %>% 
  unnest_tokens(word, desc)

thomas_text %>% head()
```

We have created a dataset where each row is a word from the description of a face mask product supplier from the Thomasnet database. These results are limited to the Us. We are going to see if we can use text analytics to categorize specific companies by their product mix. 

Based on a review of the Thomasnet output, it seems as though there is a lot of specific product information about what a given supplier provides, even if there are no details about sales or employees. 

```{r}
example <- function(data, comp) {
  data %>% 
    filter(company == comp) %>% 
    select(desc)
}
```


```{r}
thomas_fm %>% 
  example(comp = "Pacific Imports")
```

The products that other companies state that they produce are less clearly applicable to the COVID-19 response. 

```{r}
thomas_fm %>% 
  example(comp = "Blue Beat Digital") 
```

However, this does not mean that these products are NOT useful.

### Begining to tidy the text

We start by removing "stop words" such as "the", "of," to" and so forth. We can use a previously defined dictionary here, however we will also want to modify it to make sure to preserve some words we care about. 

```{r}
stop_words <- stop_words %>% 
  filter(!word %in% c("beyond", "changes",  "contains", "containing", "contain", "nearly", "only", "novel", "plus", "possible", "particular", "particularly", "provides", "probably")) %>% 
  filter(lexicon == "SMART")
```

We also create a list of "product" words that tell us useful information but do not allow us much differentiation between groups. 


```{r}
product_words <- as.data.frame(c("covid", "coronavirus", "N95", "KN95", "mask", "masks", "cloth", "surgical", "medical", "ppe", "disposable", "19", "dust", "industrial", "gloves", "gowns", "respirators", "face", "include", "product", "equipment", "supplies", "including", "safety", "respirator", "protective", "brands", "kn95", "3m", "full", "brands", "covid-19", "valve", "shields", "products", "n95", "reusable", "facepiece", "protection", "dental", "devices", "care", "glasses", "kits", "clothing", "air", "breathing", "filter", "eye", "respiratory", "valves", "nose", "head", "hand", "goggles", "filters", "latex", "ply", "sanitizer", "crisis"))

colnames(product_words) <- "word"
```



```{r}
tidy_thomas <- thomas_text %>% 
  anti_join(stop_words) %>% 
  filter(word != "19") %>% 
  mutate(word = str_replace(word, "covid", "covid-19"))
```

```{r}
thomas_noprod <- tidy_thomas %>% 
  anti_join(product_words)
```


```{r}
top_words <- thomas_noprod %>%
  group_by(broad_loc, specific_product) %>% 
  count(word, sort = TRUE) 
```

```{r}
resp <- top_words %>% 
  filter(specific_product == "Respirators Only") %>%
  filter(broad_loc %in% c("Distributor", "Primary Manufacturer")) %>% 
  group_by(broad_loc) %>% 
  filter(n > 5) %>% 
  ggplot(aes(word, n, fill = word)) +
  geom_col() +
  facet_wrap(~broad_loc) +
  labs(title = "Top Non-Product Words for Suppliers Producing Respirators Only", subtitle = "Thomasnet, 5/29/2020", y = "") +
  theme_bw() + 
  theme(axis.text.x = element_blank(), axis.ticks.x = element_blank())
```

```{r}
fm <- top_words %>% 
  filter(specific_product == "Face Masks Only") %>% 
  filter(broad_loc %in% c("Distributor", "Primary Manufacturer")) %>% 
  group_by(broad_loc) %>% 
  filter(n > 6) %>% 
  ggplot(aes(word, n, fill = word)) +
  geom_col() +
  facet_wrap(~broad_loc) +
  labs(title = "Top Non-Product Words for Suppliers Producing Face Masks Only", subtitle = "Thomasnet, 5/29/2020", y = "") +
  theme_bw() + 
  theme(axis.text.x = element_blank(), axis.ticks.x = element_blank())
```

```{r}
both <- top_words %>% 
  filter(specific_product == "Respirators and Face Masks") %>% 
  filter(broad_loc %in% c("Distributor", "Primary Manufacturer")) %>% 
  group_by(broad_loc) %>% 
  filter(n > 10) %>% 
  ggplot(aes(word, n, fill = word)) +
  geom_col() +
  facet_wrap(~broad_loc) +
  labs(title = "Top Non-Product Words for Suppliers Producing Respirators and Face Masks", subtitle = "Thomasnet, 5/29/2020", y = "") +
  theme_bw() + 
  theme(axis.text.x = element_blank(), axis.ticks.x = element_blank())
```

We see that there do appear to be some differences between our categories. 

## An Attempt at Topic Modeling

First we turn our tidy object into a document term matrix. 

```{r}
thomas_count <- tidy_thomas %>% 
  group_by(company, word) %>% 
  count()

tidy_thomas <- left_join(tidy_thomas, thomas_count)
```


```{r}
thomas_corpus <- tidy_thomas %>% 
  cast_dtm(company, word, n)
```

```{r}
thomas_corpus
```


TO CONTINUE LATER!
