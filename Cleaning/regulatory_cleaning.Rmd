---
title: "FDA Cleaning"
author: "Nikhil Kalathil"
date: "5/27/2021"
output: html_document
---
```{r, include = FALSE}
library(tidyverse)
library(rvest)
library(rebus)
library(lubridate)
library(here)
library(ggthemes)
library(tm)
library(RColorBrewer)
library(ggnewscale)
library(ggridges)
library(ggrepel)
```

```{r}

box_dir <- "C:/Users/Nikhil Kalathil/Box/COVID 19 Master Folder/Data/Masks/FDA/"

```

```{r}
box_here <- function(file) {
  paste(box_dir, file, sep = "")
}
```


This document provides a procedure to clean and organize previously webscraped NIOSH data, as well as FDA 510K clearance data from 1996 to the present. We download data from 1996-Present (April, 2021) from the FDA: https://www.fda.gov/medical-devices/510k-clearances/downloadable-510k-files, filter the data for products of interest (mask and respirator FDA 510K product codes, and the words: "mask", "respirator", "filtering", and "ventilator")

```{r}
fda510_all <- read_csv(box_here("fda_510_96_present.csv")) 
```
```{r}
fda510_focus <- fda510_all %>% 
  filter(PRODUCTCODE %in% c("FXX", "OXZ", "MSH", "ONT") | str_detect(DEVICENAME, fixed("mask", ignore_case = TRUE)) |
           str_detect(DEVICENAME, fixed("respirator", ignore_case = TRUE)) | 
           str_detect(DEVICENAME, fixed("filtering", ignore_case = TRUE)) | 
             str_detect(DEVICENAME, fixed("ventilator", ignore_case = TRUE)))
```


```{r}
fda_510_all <- fda510_focus %>%
  mutate(APPLICANT = str_replace_all(APPLICANT, "&", "And"), 
          STREET1 = gsub("#.*","",STREET1)) %>%  
  mutate(address = paste(APPLICANT, STREET1, STREET2, CITY, STATE, COUNTRY_CODE, ZIP, sep = ", ")) %>% 
  mutate(address = case_when(
    str_detect(APPLICANT, "PURITAN BENNETT CORP.") ~ paste(STREET1, STREET2, CITY, STATE, COUNTRY_CODE, ZIP, sep = ", "), 
    TRUE ~ address
  )) %>% 
   mutate(address = str_replace_all(address, ",,", ","), 
         address = str_replace_all(address, " NA,", ""))
```


We then use a combination of product codes and device name keyword searches to categorize specific products of interest: Oxygen, CPAP/Sleep/Nasal, Vented and Non-Vented, or CPR Masks, or  Nebulizers (refered to as "Technical Masks"); Ventilator or Respiratory Systems; Surgical Face Masks; Surgical Respirators; and Tests, Panels, Reagents, or other Diagnostic Kits. 

We specify these products because they represent COVID-19 related medical supplies, or products that share relevant properties with COVID-19 related medical supplies

```{r}
product_org <- function(data) {
  data %>% 
    mutate(beauty_other = PRODUCTCODE %in% c("OHS", "CAF", "EBI", "LPL") | 
             str_detect(device, fixed("wrinkle", ignore_case = TRUE)) | 
           str_detect(device, fixed("acne", ignore_case = TRUE)) | 
           str_detect(device, fixed("beauty", ignore_case = TRUE)) | 
           str_detect(device, fixed("light", ignore_case = TRUE)) | 
           str_detect(device, fixed("belt", ignore_case = TRUE)) | 
             str_detect(device, fixed("masking", ignore_case = TRUE)) | 
             str_detect(device, fixed("masker", ignore_case = TRUE)), 
         software = str_detect(device, fixed("software", ignore_case = TRUE)), 
         nasal = PRODUCTCODE %in% c("CBN", "BYF", "CAF", "CBP", "CCQ", "OBN") | 
           str_detect(device, fixed("pillow", ignore_case = TRUE)) | 
           str_detect(device, fixed("sleep", ignore_case = TRUE)) |
           str_detect(device, fixed("nasal", ignore_case = TRUE)) | 
           str_detect(device, "PAP") | 
           str_detect(device, fixed("vented", ignore_case = TRUE)) | 
           str_detect(device, "CPR") | 
           str_detect(device, fixed("performax", ignore_case = TRUE)) | 
           str_detect(device, fixed("hospital", ignore_case = TRUE)) | 
           str_detect(device, fixed("respcare", ignore_case = TRUE)) |
           str_detect(device, fixed("gel", ignore_case = TRUE)) | 
           str_detect(device, fixed("mirage", ignore_case = TRUE)) | 
           str_detect(device, fixed("capno", ignore_case = TRUE)) | 
           str_detect(device, fixed("panoramic", ignore_case = TRUE)) | 
           str_detect(device, fixed("rede mask", ignore_case = TRUE)) | 
           (str_detect(device, fixed("full face mask", ignore_case = TRUE)) & 
              str_detect(device, fixed("reusable", ignore_case = TRUE), negate = TRUE)) | 
            (str_detect(device, fixed("model", ignore_case = TRUE)) & 
              str_detect(device, fixed("white knight", ignore_case = TRUE), negate = TRUE) & str_detect(device, fixed("imask", ignore_case = TRUE))), 
         test = str_detect(device, fixed("panel", ignore_case = TRUE)) | 
           str_detect(device, fixed("test", ignore_case = TRUE)) | 
           str_detect(device, fixed("gating", ignore_case = TRUE)) | 
           str_detect(device, fixed("screening", ignore_case = TRUE)), 
         monitor = str_detect(device, fixed("monitor", ignore_case = TRUE)), 
         module = str_detect(device, fixed("module", ignore_case = TRUE)), 
         respiratory = PRODUCTCODE %in% c("BZD", "CBK", "BTM", "BWF", "BYT", "MNT") | (!PRODUCTCODE %in% c("FXX") & str_detect(device, fixed("respiratory", ignore_case = TRUE))) | 
           str_detect(device, fixed("ventilator", ignore_case = TRUE)), 
         thermoplastic = PRODUCTCODE %in% c("BYP", "DZB") | 
           str_detect(device, fixed("thermoplastic", ignore_case = TRUE)) | 
           str_detect(device, fixed("reverse pull", ignore_case = TRUE)), 
         surgical_medical = PRODUCTCODE %in% c("FXX", "OXZ") | 
           str_detect(device, fixed("surgical", ignore_case = TRUE)) | 
           str_detect(device, fixed("medical", ignore_case = TRUE)) |
           str_detect(device, fixed("procedure", ignore_case = TRUE)) | 
           str_detect(device, fixed("disposable", ignore_case = TRUE)) | 
           str_detect(device, fixed("face mask", ignore_case = TRUE)), 
         n95 = PRODUCTCODE %in% c("MSH", "ONT") | 
           str_detect(device, "N95")
         ) %>% 
  mutate(product = case_when(
    surgical_medical == TRUE ~ "Surgical Face Mask", 
  )) %>% 
    mutate(product= case_when( 
           n95 == TRUE ~ "Surgical Respirator", 
           TRUE ~ product)) %>% 
  mutate(product = case_when(
    beauty_other == TRUE ~ "Hearing, Beauty, or Body Related Product", 
    nasal == TRUE ~ "Oxygen, CPAP/Sleep/Nasal, Nebulizer, Vented and Non-Vented, or CPR Mask",
    thermoplastic == TRUE ~ "Thermoplastic or Correctional Mask",
    respiratory == TRUE ~ "Ventilatory or Respiratory System", 
    TRUE ~ product)
  ) %>% 
  mutate(product = case_when(
    monitor == TRUE ~ "Monitor", 
    test == TRUE ~ "Test, Panel, Reagent, or other Diagnostic Kit", 
    module == TRUE ~ "External Module",
    TRUE ~ product)) %>% 
  mutate(product = case_when(
    software == TRUE ~ "Software Product", 
    TRUE ~ product
  ))
}
```


```{r}
fda_510_all %>% 
  rename(device = DEVICENAME) %>% 
  product_org() %>% 
  filter(is.na(product)) %>% 
  select(APPLICANT, PRODUCTCODE, device)
```

```{r}
fda_struc <- fda510_focus %>% 
  rename(device = DEVICENAME) %>% 
  product_org() 
```

```{r}
rel_struc <- fda_struc %>% 
  filter(product %in% c("Ventilatory or Respiratory System", "Oxygen, CPAP/Sleep/Nasal, Nebulizer, Vented and Non-Vented, or CPR Mask", "Surgical Respirator", "Surgical Face Mask", "Test, Panel, Reagent, or other Diagnostic Kit")) %>% 
  mutate(product = case_when(
    str_detect(product, "Nebulizer") ~ "Technical Mask", 
    TRUE ~ product
  )) %>% 
  mutate(ddate = mdy(DECISIONDATE))
```

```{r}
fda_formatch <- rel_struc %>% 
  filter(year(ddate) > 2008)
```

```{r}
saveRDS(fda_formatch, box_here("fda_formatch.RDS"))
```


```{r}
tot_graph <- rel_struc %>% 
  mutate(date = mdy(DECISIONDATE)) %>% 
  mutate(month = month(date, label=TRUE), year = year(date)) %>% 
  group_by(month, year, product) %>% 
  count() %>% 
  mutate(date = paste(month, year, sep = " ")) %>% 
  mutate(date_1 =  make_date(year = year, month = month, day = 01)) %>% 
  arrange(date_1) %>% 
  ungroup() %>% 
  mutate(total = cumsum(n))
```

```{r}
my_col <- c(brewer.pal(5, "Set3")[1], brewer.pal(5, "Set2")[2], brewer.pal(7, "Set2")[7], brewer.pal(5, "Set2")[3], brewer.pal(8, "Set2")[8])
```

```{r}
fig_1 <- tot_graph %>% 
  group_by(product) %>% 
  count() %>% 
  ggplot(aes(reorder(product, n), n, group = product)) + 
  geom_col(aes(fill = reorder(product, -n)), position = "stack", color = "Black", show.legend = FALSE) + 
  theme_bw() + 
  coord_flip() + 
  scale_fill_manual(values = my_col) + 
  labs(title = "Total FDA510K Clearances for Potentially COVID-19 Relevant Products", subtitle = "1996-Present", x = "", y = "")+ 
  theme(plot.title = element_text(size = 18),
        axis.text = element_text(size = 12))

fig_1
```

We now split our data into two categories around 2009 (the last pandemic like event with H1N1) to define: current and legacy products. 

```{r}
legacy <- c(brewer.pal(9, "Greys")[4], brewer.pal(9, "Greys")[7])
```


```{r}
fig_2 <- tot_graph %>% 
  mutate(legacy = case_when(
    year >= 2010 ~ "Current Products", 
    year < 2010 ~ "Legacy Products"
  )) %>% 
  group_by(product, legacy) %>% 
  count() %>% 
    mutate(lab1 = case_when(
    str_detect(product, "Ventilatory") & legacy == "Legacy Products" ~ "Legacy Products"
  )) %>% 
  mutate(lab2 = case_when(
    str_detect(product, "Surgical Face") & legacy == "Current Products" ~ "Current Products"
  )) %>% 
  ggplot(aes(reorder(product, n), n, group = legacy)) + 
  geom_col(aes(fill = reorder(product, -n)), position = "stack", color = "Black", show.legend = FALSE) + 
  scale_fill_manual(values = my_col) + 
  new_scale_fill() + 
  geom_col(aes(fill = legacy), alpha = 0.5, position = "stack", color = "Black", show.legend = FALSE) + 
  geom_text(y = 50, aes(label = lab1), size = 8) +
  geom_text(aes(label = lab2), size = 8) +
  theme_bw() + 
  coord_flip() + 
  scale_fill_manual(values = legacy) + 
  labs(title = "Total FDA510K Clearances for Specific Products", subtitle = "1996-Present, Legacy Break Year = 2009", x = "", y = "") + 
    theme(plot.title = element_text(size = 18),
        axis.text = element_text(size = 12))  

fig_2
```

We see that ventliator products are mostly legacy products, while surgical face masks are mostly current products. 

```{r}
tot_graph %>% 
  group_by(product) %>% 
  summarize(max(date_1), n = n())
```
```{r}
fig_3 <- tot_graph %>% 
  mutate(legacy = case_when(
    year >= 2018 ~ "Current Products", 
    year < 2018 ~ "Legacy Products"
  )) %>% 
  group_by(product, legacy) %>% 
  count() %>% 
    mutate(lab1 = case_when(
    str_detect(product, "Ventilatory") & legacy == "Legacy Products" ~ "Legacy Products (Before 2018)"
  )) %>% 
  mutate(lab2 = case_when(
    str_detect(product, "Surgical Face") & legacy == "Current Products" ~ "Current Products"
  )) %>% 
ggplot(aes(reorder(product, n), n, group = legacy)) +
  geom_col(aes(fill = reorder(product, -n), label = legacy), position = "stack", color = "Black", show.legend = FALSE) + 
  scale_fill_manual(values = my_col) + 
  new_scale_fill() + 
  geom_col(aes(fill = legacy), alpha = 0.5, position = "stack", color = "Black", show.legend = FALSE) + 
  geom_text(y = 80, aes(label = lab1), size = 8) +
  theme_bw() + 
  coord_flip() + 
  scale_fill_manual(values = legacy) + 
  labs(title = "Total FDA510K Clearances for Specific Products", subtitle = "1996-Present, Legacy Break Year = 2018", x = "", y = "") + 
    theme(plot.title = element_text(size = 18),
        axis.text = element_text(size = 12))  
```


```{r}
fig_3 <- tot_graph %>% 
  mutate(legacy = case_when(
    year >= 2018 ~ "Current Products", 
    year < 2018 ~ "Legacy Products"
  )) %>% 
  group_by(product, legacy) %>% 
  summarize(last_date = paste(month(max(date_1), label=TRUE), year(max(date_1)), sep = ", "), n = n()) %>% 
    mutate(max_n = case_when(
      legacy == "Current Products" ~ max(n)), 
      lab1 = case_when(
    str_detect(product, "Ventilatory") & legacy == "Legacy Products" ~ "Legacy Products (Before 2018)"
  )) %>% 
  mutate(lab2 = case_when(
    str_detect(product, "Surgical Face") & legacy == "Current Products" ~ "Current Products"
  ), 
  last_date = case_when(
    legacy == "Current Products" ~ last_date
  )) %>% 
ggplot(aes(reorder(product, n), n, group = legacy)) +
  geom_col(aes(fill = reorder(product, -n), label = legacy), position = "stack", color = "Black", show.legend = FALSE) + 
  scale_fill_manual(values = my_col) + 
  new_scale_fill() + 
  geom_col(aes(fill = legacy), alpha = 0.5, position = "stack", color = "Black", show.legend = FALSE) + 
  geom_text(y = 80, aes(label = lab1), size = 8) +
  geom_text(aes(label = lab2), size = 8) +
  theme_bw() + 
  coord_flip() + 
  scale_fill_manual(values = legacy) + 
  labs(title = "Total FDA510K Clearances for Specific Products", subtitle = "1996-Present, Legacy Break Year = 2018", x = "", y = "") + 
    theme(plot.title = element_text(size = 18),
        axis.text = element_text(size = 12))  
```

We now focus on the period between 2019 and the present to capture new FDA 510K clearances and during the pandemic. We focus primarily on Surgical Face Masks, Ventilators, and tests. 

```{r}
my_col2 <- c(brewer.pal(5, "Set2")[2],  brewer.pal(8, "Set2")[8], brewer.pal(5, "Set3")[1])
```


```{r}
fda_fig1 <- tot_graph %>% 
  filter(year > 2019, product %in% c("Ventilatory or Respiratory System", "Surgical Face Mask", "Test, Panel, Reagent, or other Diagnostic Kit")) %>% 
  ggplot(aes(reorder(date, date_1), n, group = product)) +
  geom_col(aes(fill = product), position = "stack", color = "Black") + 
  theme_bw() +
  scale_fill_manual(values = my_col2) +
  theme(axis.text.x=element_text(angle=60, hjust=1), 
        legend.position = "bottom") +
  labs(x = "", y = "Monthly FDA 510K Clearance Decisions", title = "Monthly FDA 510K Clearance Decisions for Select COVID-19 Relevant Products", fill = "") + 
      theme(plot.title = element_text(size = 18),
        axis.text = element_text(size = 12))  


fda_fig1
```

```{r}
country_colors <- c(brewer.pal(9, "OrRd")[7], brewer.pal(7, "Set2")[7], brewer.pal(7, "Set2")[1], brewer.pal(9, "Set1")[2])
```


```{r}
country_graph1 <- rel_struc %>% 
  filter(product %in% "Surgical Face Mask") %>% 
  mutate(date = mdy(DECISIONDATE)) %>% 
  mutate(month = month(date, label=TRUE), year = year(date)) %>% 
  group_by(month, year, COUNTRY_CODE) %>% 
  count() %>% 
  mutate(date = paste(month, year, sep = " ")) %>% 
  mutate(date_1 =  make_date(year = year, month = month, day = 01)) %>% 
  arrange(date_1)%>% 
  filter(year > 2019) %>% 
  ggplot(aes(reorder(date, date_1), n, group = COUNTRY_CODE)) + 
  geom_col(aes(fill = COUNTRY_CODE), position = "stack", color = "Black") +
  scale_fill_manual(values = country_colors) + 
  theme_bw() + 
    theme(axis.text.x=element_text(angle=60, hjust=1), 
        legend.position = "bottom") +
  labs(x = "", y = "Monthly FDA 510K Clearance Decisions", title = "Monthly FDA 510K Clearance Decisions for Surgical Face Masks", subtitle = "By Country", fill = "Country")

country_graph
  
```

```{r}
country_graph2 <- rel_struc %>% 
  filter(product %in% "Surgical Face Mask") %>% 
  mutate(date = mdy(DATERECEIVED)) %>% 
  mutate(month = month(date, label=TRUE), year = year(date)) %>% 
  group_by(month, year, COUNTRY_CODE) %>% 
  count() %>% 
  mutate(date = paste(month, year, sep = " ")) %>% 
  mutate(date_1 =  make_date(year = year, month = month, day = 01)) %>% 
  arrange(date_1)%>% 
  filter(year > 2019) %>% 
  ggplot(aes(reorder(date, date_1), n, group = COUNTRY_CODE)) + 
  geom_col(aes(fill = COUNTRY_CODE), position = "stack", color = "Black") +
  scale_fill_manual(values = country_colors) + 
  theme_bw() + 
    theme(axis.text.x=element_text(angle=60, hjust=1), 
        legend.position = "bottom") +
  labs(x = "", y = "Monthly FDA 510K Clearance Decisions", title = "Monthly FDA 510K Clearance Decisions for Surgical Face Masks", subtitle = "By Country", fill = "Country")

country_graph2
```


```{r}
rel_struc %>% 
  filter(product %in% "Surgical Face Mask") %>% 
  mutate(date = mdy(DECISIONDATE)) %>% 
  mutate(month = month(date, label=TRUE), year = year(date)) %>% 
  filter(year > 2019) %>% 
  group_by(month, year, COUNTRY_CODE) %>% 
  count() %>% 
  group_by(COUNTRY_CODE) %>%
  summarize(total = sum(n))
```

```{r}
rel_struc %>% 
  filter(product %in% "Surgical Face Mask") %>% 
  mutate(ddate = mdy(DECISIONDATE),
         rdate = mdy(DATERECEIVED)) %>% 
  mutate(delay = difftime(ddate, rdate, units = "days")) %>% 
  filter(year(rdate) > 2019) %>%
  ggplot(aes(rdate, delay, group = COUNTRY_CODE)) + 
  geom_point(shape = 21, aes(fill = COUNTRY_CODE)) +
  scale_fill_manual(values = country_colors) + 
  theme_bw() 
  
```

```{r}
rel_struc %>% 
  filter(product %in% "Surgical Face Mask") %>% 
  mutate(ddate = mdy(DECISIONDATE),
         rdate = mdy(DATERECEIVED)) %>% 
  mutate(delay = difftime(ddate, rdate, units = "days")) %>% 
  filter(year(rdate) > 2019) %>%
  ggplot(aes(ddate, delay, group = COUNTRY_CODE)) + 
  geom_point(shape = 21, aes(fill = COUNTRY_CODE)) +
  scale_fill_manual(values = country_colors) + 
  theme_bw() 
```



```{r}
rel_struc %>% 
  filter(product %in% "Surgical Face Mask", COUNTRY_CODE %in% c("CN", "US")) %>% 
  mutate(ddate = mdy(DECISIONDATE),
         rdate = mdy(DATERECEIVED)) %>% 
  mutate(delay = difftime(ddate, rdate, units = "days")) %>% 
  mutate(month = month(rdate, label=TRUE), year = year(rdate)) %>% 
  mutate(date = paste(month, year, sep = " ")) %>% 
  mutate(date_1 =  make_date(year = year, month = month, day = 01)) %>% 
  arrange(date_1)%>% 
  filter(year > 2019) %>% 
  ggplot(aes(date_1, delay, group = date_1)) +
  geom_boxplot(aes(fill = COUNTRY_CODE)) + 
  geom_point(shape = 21, aes(fill = COUNTRY_CODE)) + 
  scale_fill_manual(values = country_colors) + 
  theme_bw() +
  facet_wrap(~COUNTRY_CODE) + 
  labs(title = "Days Taken to Approve FDA 510k Application for Surgical Face Masks", subtitle = "by Country", x = "Date Application was Received", y = "Days till Decision")
```

```{r}
model_date <- rel_struc %>% 
  filter(product %in% "Surgical Face Mask", COUNTRY_CODE %in% c("CN", "US")) %>% 
  mutate(ddate = mdy(DECISIONDATE),
         rdate = mdy(DATERECEIVED)) %>% 
  mutate(country = case_when(
    COUNTRY_CODE == "US" ~ 0, 
    COUNTRY_CODE == "CN" ~ 1
  )) %>% 
  mutate(delay = as.double(difftime(ddate, rdate, units = "days"))) %>% 
  mutate(month = month(rdate, label=TRUE), year = year(rdate)) %>% 
  mutate(date = paste(month, year, sep = " ")) %>% 
  mutate(date_1 =  make_date(year = year, month = month, day = 01)) %>% 
  filter(year > 2019)
```

```{r}
lm1 <- lm(delay ~ country + factor(date_1), data = model_date)
```

```{r}
library(jtools)
summ(lm1)
```

```{r}
rel_struc %>% 
  filter(product %in% "Surgical Face Mask", COUNTRY_CODE %in% c("CN", "US")) %>% 
  mutate(ddate = mdy(DECISIONDATE),
         rdate = mdy(DATERECEIVED)) %>% 
  mutate(delay = difftime(ddate, rdate, units = "days")) %>% 
  mutate(month = month(rdate, label=TRUE), year = year(rdate)) %>% 
  mutate(date = paste(month, year, sep = " ")) %>% 
  mutate(date_1 =  make_date(year = year, month = month, day = 01)) %>% 
  arrange(date_1)%>% 
  filter(year > 2019) %>% 
  write_csv(box_here("recent_fda.csv"))
```



