---
title: "niosh_cleaning"
author: "Nikhil Kalathil"
date: "11/9/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r, include = FALSE}
library(tidyverse)
library(rvest)
library(rebus)
library(lubridate)
library(here)
library(ggthemes)
```

# Current 

```{r}

box_dir <- "C:/Users/Nikhil Kalathil/Box/COVID 19 Master Folder/Data/Masks/FDA/"

```

```{r}
box_here <- function(file) {
  paste(box_dir, file, sep = "")
}
```


This program contains a procedure to download our list of NIOSH companies into an excel file, manually match those entries to the D&B Hoovers database to get: 1) employees and sales, 2) corporate family, 3) country of ownership, and 4) the DUNS number. 

```{r}
niosh_manf_info <- readRDS(box_here("niosh_manf_info.RDS"))
```


```{r}
niosh_manf_info %>% 
  distinct(company) %>% 
  mutate(id = seq(n())) %>% 
  write_csv(box_here("niosh_info.csv"))
```

```{r}
niosh_manf <- niosh_manf_info %>% 
  distinct(company) %>% 
  mutate(id = seq(n())) %>% 
  left_join(niosh_manf_info) %>% 
  mutate(company = case_when(
    str_detect(company, "Honeywell") ~ "Honeywell International", 
    str_detect(company, "GM Global") ~ "General Motors", 
    TRUE ~ company
  ), id = case_when(str_detect(company, "Honeywell") ~ as.numeric(21), TRUE ~ as.numeric(id)))
```

```{r}
niosh_loc <- read_csv(box_here("niosh_info_dbh.csv")) %>% 
  rename(comp = company) %>% 
  mutate(comp = case_when(
    str_detect(comp, "GM Global") ~ "General Motors", 
    TRUE ~ comp
  ))
```
```{r}
niosh_master <- left_join(niosh_manf, niosh_loc, by = "id")
```

```{r}
remove <- c("Limited" ,"Ltd", "LTD", "Incorporated", "Company",  "Corporation", "Co", "Inc",  "[[:punct:]]", "LLC")
```

```{r}
niosh_master_clean <- niosh_master %>% 
  select(-c("company")) %>% 
  rename(company = comp) %>% 
  group_by(company) %>% 
  mutate(tal = seq(n())) %>% 
  filter(tal == 1) %>% 
  mutate(master = 1) %>% 
  select(-c("tal")) %>% 
  mutate(company = case_when(
    id == 20 ~ "Draeger Inc.", 
    str_detect(company, "Indiana Face Mask") ~ "Indiana Face Mask",
    TRUE ~ company
  ), 
  comp_match = tolower(str_trim(str_remove_all(company, paste(remove, collapse = "|")))))
```


```{r}
niosh_apprs <- readRDS(box_here("niosh_clean.RDS")) %>% 
  mutate(company = case_when(
      str_detect(company, "Honeywell") ~ "Honeywell International",
      
      str_detect(model_no, fixed("x-plore", ignore_case = TRUE)) ~ "Draeger Inc.",
      str_detect(company, "Indiana Face Mask") ~ "Indiana Face Mask",
      TRUE ~ company), 
      company = case_when(
         !is.na(private_label) & private_label != 0 ~ private_company_prnt, 
         TRUE ~ company), 
      comp_match = tolower(str_trim(str_remove_all(company, paste(remove, collapse = "|")))))
```


```{r}
niosh_2020 <- niosh_apprs %>% 
  filter(year(mdy(appr_date)) > 2018) %>% 
  left_join(niosh_master_clean, by = c("comp_match")) %>% 
  rename(company = company.y) %>% 
  select(-c("company.x")) %>% 
  mutate(appr_date = case_when(
    str_detect(company, "Global Safety") ~ mdy("01/21/2021"), 
    TRUE ~ mdy(appr_date)
  ),
         company = case_when(
   str_detect(company, "MSA Innovation") ~ "MSA Safety, Inc.", 
   TRUE ~ company
  )) 
```

```{r}
saveRDS(niosh_2020, box_here("niosh_2020.RDS"))
```

```{r}
niosh_address <- niosh_2020 %>% 
  filter(hq_country == "US") %>% 
  select(DUNS, company, info)
```


# OLD 


## NIOSH

```{r}
niosh_all <- readRDS(box_here("niosh_webscraped.RDS"))
```

We start by cleaning the company info column, using the "external icon" identifier as a separating point and joining the product information with notes about whether or not it is a private label product (and who the private label is for). 

```{r}
niosh_clean <- niosh_all %>% 
  mutate(dist_auth = case_when(
    str_detect(comp_info, fixed("distribution", ignore_case = TRUE)) ~ 1, 
    TRUE ~ 0
  )) %>% 
  separate(comp_info, into = c("company", "contact_info"), sep = "external icon") %>% 
  mutate(private_label = str_extract(contact_info, "\\[.+?\\]")) %>% 
  mutate(private_label = str_replace_all(private_label, "\\[", ""), 
         private_label = str_replace_all(private_label, "\\]", "")) %>% 
  mutate(obsolete = str_detect(model_no, fixed("obsolete", ignore_case = TRUE))|
           str_detect(approval_num, "OBSOLETE")) %>% 
  mutate(contact_info = str_trim(gsub("\\[[^][]*]", "", contact_info))) %>% 
  filter(obsolete != TRUE) %>% 
  mutate(contact_info = str_trim(gsub("\\[[^][]*]", "", contact_info))) %>% 
  mutate(company = case_when(
    str_detect(company, "Air Filtration") ~ "Air Filtration Solutions, Ltd.", 
    TRUE ~ company), 
    company = case_when(
      str_detect(company, "Alpha Pro") ~ "Alpha Pro-Tech", 
      TRUE ~ company), 
    company = case_when(
      str_detect(company, "Gerson") ~ "Louis M. Gerson Company, Inc.", 
      TRUE ~ company
    ), 
    company = case_when(
      str_detect(company, "Package") ~ "San M Package Company, Ltd.", 
      TRUE ~ company
    ) ,
    company = case_when(
      str_detect(company, "Venus") ~ "Venus Safety & Health", 
      TRUE ~ company
    ), 
    company = case_when(
      str_detect(company, "Xiantao Zhongyi") ~ "Xiantao Zhongyi Safety Protection Products", 
      TRUE ~ company
    ), 
    company = case_when(
      str_detect(company, "Honeywell") ~ "Honeywell International Inc.",
      TRUE ~ company))
```



## match aproval numbers to dates

To start organizing by approval number, we begin by scraping the web for the corresponding date for each approval number. We have to webscrape this information. 

```{r}

base_url <- "https://wwwn.cdc.gov/NIOSH-CEL/ApprovalDetails?schedule=84A&approvalNum="

make_url <- function(x) {
  URLencode(paste(base_url, x, sep = ""))
}
```



```{r}
niosh_appr <- niosh_clean %>% 
  ungroup() %>% 
  distinct(approval_num, appr_num) %>% 
  mutate(apprv_url = map(appr_num, make_url)) %>% 
  arrange(appr_num)
```

```{r}
get_date <- function(url) { 
  table <- tryCatch(read_html(url) %>% 
                     html_table(), error = function(e){NA})
  
  if(is.na(table[1])){
     return(NA)
  }
  
  else {
    x1 <- table[3] 
    x <- x1[[1]] %>% 
      filter(X1 == "Approval Date") %>% 
      select(X2) 
  return(x[1,])
  }
 }
```


```{r}
niosh_appr_date <- niosh_appr %>% 
  mutate(appr_date = map(apprv_url, get_date))
```


```{r , eval = FALSE}
for(i in 1:nrow(niosh_appr)) {
  print(niosh_appr$appr_num[i])
  niosh_appr$appr_date[i] <- get_date(niosh_appr$apprv_url[i] %>% unlist())
}
```

```{r}
niosh_appr_date %>% 
  saveRDS(box_here("appr_dates.RDS"))
```


```{r}
appr_info %>% 
  saveRDS(box_here("niosh_manf_info.RDS"))
```

```{r}
appr_info <- readRDS(box_here("niosh_manf_info.RDS"))
```


```{r}
niosh_manf <- appr_info
```

```{r}
niosh_loc <- read_csv(box_here("niosh_info_dbh.csv")) %>% 
  rename(comp = company) %>% 
  mutate(comp = case_when(
    str_detect(comp, "GM Global") ~ "General Motors", 
    TRUE ~ comp
  ))
```
```{r}
niosh_master <- left_join(niosh_manf, niosh_loc, by = "id")
```

```{r}
remove <- c("Limited" ,"Ltd", "LTD", "Incorporated", "Company",  "Corporation", "Co", "Inc",  "[[:punct:]]", "LLC")
```

```{r}
niosh_master_clean <- niosh_master %>% 
  select(-c("company")) %>% 
  rename(company = comp) %>% 
  group_by(company) %>% 
  mutate(tal = seq(n())) %>% 
  filter(tal == 1) %>% 
  mutate(master = 1) %>% 
  select(-c("tal")) %>% 
  mutate(company = case_when(
    id == 20 ~ "Draeger Inc.", 
    str_detect(company, "Indiana Face Mask") ~ "Indiana Face Mask",
    TRUE ~ company
  ), 
  comp_match = tolower(str_trim(str_remove_all(company, paste(remove, collapse = "|")))))
```


```{r}
niosh_apprs <- readRDS(box_here("niosh_clean.RDS")) %>% 
  mutate(company = case_when(
      str_detect(company, "Honeywell") ~ "Honeywell International",
      
      str_detect(model_no, fixed("x-plore", ignore_case = TRUE)) ~ "Draeger Inc.",
      str_detect(company, "Indiana Face Mask") ~ "Indiana Face Mask",
      TRUE ~ company), 
      company = case_when(
         !is.na(private_label) & private_label != 0 ~ private_company_prnt, 
         TRUE ~ company), 
      comp_match = tolower(str_trim(str_remove_all(company, paste(remove, collapse = "|")))))
```


```{r}
niosh_2020 <- niosh_apprs %>% 
  filter(year(mdy(appr_date)) > 2019) %>% 
  left_join(niosh_master_clean, by = c("comp_match")) %>% 
  rename(company = company.y) %>% 
  select(-c("company.x")) %>% 
  mutate(company = case_when(
   str_detect(company, "MSA Innovation") ~ "MSA Safety, Inc.", 
   TRUE ~ company
  )) 
```

```{r}
saveRDS(niosh_2020, box_here("niosh_2020.RDS"))
```


## GEOCODING FOR COUNTRIES (OLD)

We now use Google's geocoding service to identify the country of origin for each company. 

```{r, echo = FALSE, Include = FALSE}
api_key <- c("AIzaSyA1pwzK3BaX7_um-_TUrS7aGfCHQvp68b8")
```

We define our function, which will take an address as an input and output a latitude and longitude result. 

```{r}
geocodeAddress <- function(address) {
  require(RJSONIO)
  url <- "https://maps.googleapis.com/maps/api/geocode/json?address="
  url <- URLencode(paste(url, address, sep = ""))
  url <- URLencode(paste(url, "&key=", api_key, sep = ""))
  x <- fromJSON(url, simplify = FALSE)
  print(x$status)
  if (x$status == "OK") {
    out <- c(x$results[[1]]$geometry$location$lng,
             x$results[[1]]$geometry$location$lat,
             x$results[[1]]$formatted_address)
  } else {
    out <- NA
  }
  Sys.sleep(0.2)  # API only allows 5 requests per second
  out
}
```


```{r}
niosh_formaps <- niosh_simp %>% 
  filter(obsolete != 1 ) %>% 
  group_by(company, contact_info, private_label, specific_product) %>% 
  count() 
```

```{r, include = FALSE}
for(i in 1:nrow(niosh_formaps))
{
  result <- geocodeAddress(niosh_formaps$company[i])
  niosh_formaps$long[i] <- as.numeric(result[1])
  niosh_formaps$lat[i] <- as.numeric(result[2])
  niosh_formaps$form_address[i] <- as.character(result[3])

}
```

Examining companies that returned 0 results, we manually impute countries for our missing results. 

```{r}
niosh_country <- niosh_formaps %>% 
  mutate(country = str_trim(sub('.*\\,', '', form_address))) %>% 
  mutate(country = case_when(
    company %in% c("4522915 Canada Inc", "Futuremed Health Care Products LP", "Jarvis Imports 2000, Ltd.") ~ "Canada", 
    company %in% c("A & Z Pharmaceutical, Inc.", "Aidway Personal Care Product, Inc." ,"Inovel, LLC", "J & A Global Inc.", "Jamestown Distributors", "NafiaS Incorporated", "Raivansa, Inc.", "The Home Depot", "ValuMax International", "United States Mask, LLC") ~ "USA", 
    company %in% c("Andanda Industry Technology Co., Ltd.", "Chen Wei Safety Corporation", "Danyang Kseibi Tools Company, Ltd." ,"Xiantao Zhongyi Safety Protection Products Company, Ltd.", "Nara Safe, Ltd.") ~ "China", 
    company %in% c("Chilean IPRO") ~ "Chile", 
    company %in% c("CIG Safety PTE, Ltd.") ~ "Singapore", 
    company %in% c("Omikenshi Company", "Shigematsu Works Company, Ltd.", "Shirohato Company, Ltd.", "San M Package Company, Ltd.") ~ "Japan", 
    company %in% c("Ever Green Company, Ltd. 82-31-425-0596") ~ "South Korea",
    company %in% c("Sagax Safety Products, LLC") ~ "Panama", 
    company %in% c("San Huei United Company, Ltd.", "Southern Ace Trading Corporation") ~ "Taiwan", 
    str_detect(contact_info, "China") ~ "China", 
    TRUE ~ country))
```

```{r}
niosh_country_clean <- niosh_country %>% 
  mutate(country = case_when(
    str_detect(country, "Singapore") ~ "Singapore", 
    str_detect(form_address, "Taiwan") ~ "Taiwan", 
    str_detect(form_address, "United Arab Emirates") ~ "United Arab Emirates", 
    str_detect(form_address, "China,") ~ "China", 
    str_detect(form_address, "Hong Kong") ~ "Hong Kong", 
    str_detect(form_address, "Japan") ~ "Japan",
    TRUE ~ country
  ))
```

```{r}
niosh_country_clean %>% group_by(company) %>% 
  mutate(tal = seq(n())) %>% 
  filter(tal == 1) %>% 
  select(company, country, contact_info,  form_address) %>% 
  view()
```


```{r}
niosh_country_clean %>% 
  saveRDS(box_here("niosh_geocoded.RDS"))
```

Next, we note that many of the companies in our data are private label companies. As such, we also want to identify the location of the parent company. To accomplish this we want to match parent companies with their address.

```{r}
niosh_notes <- readRDS(box_here("niosh_notes_webscraped.RDS")) %>%
  mutate(Company = case_when(
    str_detect(Company, "Honeywell") ~ "Honeywell International Inc.", 
    TRUE ~ Company
  )) %>% 
  rename(private_label = Notes,
         private_company_prnt = Company, 
         prnt_phone = 'Phone Number') %>% 
  mutate(private_company_prnt = str_replace(private_company_prnt, fixed("Private label of ", ignore_case = TRUE), ""), 
         private_company_prnt = str_replace(private_company_prnt, "external icon", "")) %>% 
  group_by(private_label) %>% 
  select(-c("specific_product")) %>% 
  mutate(tal = seq(n())) %>% 
  filter(tal == 1) %>% 
  select(-c("tal"))
```

```{r, include = FALSE}
for(i in 1:nrow(niosh_notes))
{
  result <- geocodeAddress(niosh_notes$private_company_prnt[i])
  niosh_notes$long[i] <- as.numeric(result[1])
  niosh_notes$lat[i] <- as.numeric(result[2])
  niosh_notes$form_address[i] <- as.character(result[3])

}
```


```{r}
notes_geocoded <- niosh_notes %>% 
  mutate(label_country = str_trim(sub('.*\\,', '', form_address))) %>% 
  mutate(label_country = case_when(
    private_company_prnt %in% c("Shuenn Bao Shing Corporation", "San Huei United Company, Ltd.") | str_detect(form_address, "Taiwan") ~ "Taiwan", 
    private_company_prnt %in% c("San M Package Company, Ltd.") ~ "Japan", 
    private_company_prnt %in% c("Shining Star Electronic Technology Co., Ltd.") ~ "China", 
    TRUE ~ label_country
  ))
```

```{r}
notes_merge <- notes_geocoded %>% 
  select(private_label, label_country, private_company_prnt)
```

```{r}
notes_merge %>% 
  saveRDS(box_here("niosh_notes.RDS"))
```

We now have a dataset where each row is an individual company model number or product line. However, NIOSH seems to process applicants in batches (each assigned an approval number). An approval number can apply to multiple companies, with one company being the "lead" and the other companies being private label manufacturers. Thus, organizing our data by approval number seems to be appropriate. 